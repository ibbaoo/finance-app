<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>ProTracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json,{
      "name": "ProTracker",
      "short_name": "ProTracker",
      "start_url": ".",
      "display": "standalone",
      "background_color": "#F2F2F7",
      "theme_color": "#007AFF",
      "orientation": "portrait-primary",
      "icons": [
        {"src": "https://img.icons8.com/fluency/192/wallet.png", "sizes": "192x192", "type": "image/png"},
        {"src": "https://img.icons8.com/fluency/512/wallet.png", "sizes": "512x512", "type": "image/png"}
      ]
    }'>

    <!-- App Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘›</text></svg>">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/wallet.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProTracker">
    <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Cropper.js for Image Editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* Performance Optimization */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateZ(0);
        }
        .dark .glass {
            background: rgba(30, 30, 32, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .gpu-accel { transform: translate3d(0,0,0); backface-visibility: hidden; perspective: 1000px; }
        .smooth-transition { transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(156, 163, 175, 0.8); }
        .disabled-overlay { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #007AFF; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Mobile Safe Area Helpers */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pt-safe-offset { padding-top: calc(env(safe-area-inset-top) + 9rem); }
        .top-safe-offset { top: calc(env(safe-area-inset-top) + 9.5rem); }
        
        /* Animations */
        @keyframes floatIn { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { 0% { transform: translateY(100%); } 100% { transform: translateY(0); } }
        @keyframes slideUpMobile { 0% { transform: translateY(100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .animate-float-in { animation: floatIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .animate-slide-up-mobile { animation: slideUpMobile 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-pulse-slow { animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .pin-input { letter-spacing: 0.5em; text-align: center; font-family: monospace; }
        .cropper-view-box, .cropper-face { border-radius: 50%; } 
        .cropper-modal { opacity: 0.8; }
        
        /* Drag and Drop Styling */
        .task-card { touch-action: none; user-select: none; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        .drag-clone { position: fixed; pointer-events: none; z-index: 9999; width: 280px; opacity: 0.9; transform: rotate(3deg); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .drop-zone-active { background-color: rgba(0, 122, 255, 0.05); border: 2px dashed #007AFF; }
        
        /* Task Rich Text */
        .task-desc a { color: #007AFF; text-decoration: underline; pointer-events: auto; }
        .task-desc input[type="checkbox"] { accent-color: #007AFF; width: 1.1em; height: 1.1em; vertical-align: middle; margin-right: 6px; cursor: pointer; pointer-events: auto; }
        .task-desc { user-select: text; }

        @media (hover: hover) {
            .hover-lift { transition: transform 0.2s ease; }
            .hover-lift:hover { transform: translateY(-3px); }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] },
                    colors: { ios: { blue: '#007AFF', green: '#34C759', red: '#FF3B30', orange: '#FF9500', purple: '#5856D6', teal: '#30B0C7', gray: '#8E8E93', light: '#F2F2F7', amber: '#FFCC00' } }
                }
            }
        }
    </script>
</head>
<body class="bg-ios-light dark:bg-black text-slate-900 dark:text-white min-h-screen flex flex-col smooth-transition selection:bg-ios-blue selection:text-white overflow-hidden">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, deleteDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose to window for the main script to use
        window.fb = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut, 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            deleteDoc, 
            updateDoc, 
            arrayUnion 
        };
        
        // Signal that Firebase is ready
        window.dispatchEvent(new Event('firebaseLoaded'));
        window.isFirebaseReady = true;
    </script>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-safe-offset left-1/2 transform -translate-x-1/2 bg-gray-800/90 dark:bg-white/90 text-white dark:text-black px-6 py-3 rounded-full text-xs font-bold shadow-xl transition-all duration-300 opacity-0 pointer-events-none translate-y-[-10px] z-[200] backdrop-blur-md flex items-center gap-2 w-max max-w-[90%]">
        <i class="fa-solid fa-circle-info shrink-0"></i> <span id="toastMsg" class="truncate">Notification</span>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/20 backdrop-blur-sm p-4 transition-all duration-300">
        <div class="bg-white dark:bg-[#1c1c1e] rounded-2xl w-full max-w-xs p-5 shadow-2xl text-center animate-fade-in border border-gray-200 dark:border-gray-700 gpu-accel">
            <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-500/20 text-red-500 flex items-center justify-center mx-auto mb-3">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 dark:text-white">Confirm Action</h3>
            <p id="confirmMessage" class="text-sm text-gray-500 dark:text-gray-400 mb-6 font-medium">Proceed?</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfirm(false)" class="bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-gray-300 py-3 rounded-xl text-sm font-bold hover:bg-gray-200 dark:hover:bg-white/20 transition">Cancel</button>
                <button id="confirmYesBtn" class="bg-ios-red text-white py-3 rounded-xl text-sm font-bold hover:bg-red-600 transition shadow-lg shadow-red-500/20">Delete</button>
            </div>
        </div>
    </div>

    <!-- CROP MODAL -->
    <div id="cropModal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/95 p-4 transition-all duration-300">
        <div class="w-full max-w-lg flex flex-col h-[90vh] bg-[#1c1c1e] rounded-3xl overflow-hidden relative shadow-2xl border border-white/10 gpu-accel">
            <div class="absolute top-4 right-4 z-50">
                <button onclick="closeCropModal()" class="w-8 h-8 rounded-full bg-black/40 flex items-center justify-center text-white hover:bg-black/60 transition backdrop-blur-md"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-grow relative bg-black flex items-center justify-center overflow-hidden">
                <img id="cropImage" src="" class="max-w-full max-h-full block opacity-0">
            </div>
            <div class="bg-[#1c1c1e] p-6 pb-8 flex flex-col gap-6 border-t border-white/10">
                <div class="flex items-center gap-4 px-2">
                    <i class="fa-solid fa-minus text-gray-400 text-xs"></i>
                    <input type="range" id="zoomRange" min="0.1" max="3.0" step="0.1" value="1" class="flex-grow h-1.5 bg-gray-700 rounded-full appearance-none cursor-pointer">
                    <i class="fa-solid fa-plus text-white text-xs"></i>
                </div>
                <div class="flex justify-center gap-8 text-white text-xl">
                    <button onclick="rotateCropper(-90)" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition"><i class="fa-solid fa-rotate-left"></i></button>
                    <button onclick="resetCropper()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition text-sm font-bold text-ios-blue">RESET</button>
                    <button onclick="rotateCropper(90)" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <div class="flex gap-3 mt-2">
                    <button onclick="closeCropModal()" class="flex-1 bg-gray-800 text-white py-3.5 rounded-xl font-bold hover:bg-gray-700 transition">Cancel</button>
                    <button onclick="saveCroppedAvatar()" class="flex-1 bg-ios-blue text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition flex items-center justify-center gap-2"><i class="fa-solid fa-crop-simple"></i> Save Photo</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Task Modal (Mobile Optimized) -->
    <div id="addTaskModal" class="fixed inset-0 z-[200] hidden flex items-end md:items-center justify-center bg-black/50 backdrop-blur-sm transition-all duration-300 pt-10">
        <div class="bg-white dark:bg-[#1c1c1e] rounded-t-3xl md:rounded-3xl w-full max-w-md p-6 shadow-2xl relative animate-slide-up-mobile md:animate-fade-in gpu-accel flex flex-col max-h-[90vh] pb-safe">
            <div class="w-12 h-1 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-6 md:hidden"></div>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white" id="taskModalTitle">New Task</h2>
                <button onclick="closeTaskModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-white/20 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4 overflow-y-auto custom-scrollbar flex-grow px-1">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Task Name</label>
                    <input type="text" id="taskName" placeholder="e.g. Pay Internet Bill" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-4 py-3 text-base focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Deadline</label>
                        <input type="date" id="taskDate" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-4 py-3 text-base focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition appearance-none min-h-[48px]">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Priority</label>
                        <select id="taskPriority" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-4 py-3 text-base focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition appearance-none min-h-[48px]">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1 ml-1">
                        <label class="text-xs font-bold text-gray-400 uppercase">Description</label>
                        <button onclick="insertSubtask()" class="text-[10px] bg-ios-blue/10 text-ios-blue px-2 py-1 rounded-full font-bold hover:bg-ios-blue/20 transition flex items-center gap-1">
                            <i class="fa-regular fa-circle-check"></i> Add Subtask
                        </button>
                    </div>
                    <textarea id="taskDesc" rows="4" placeholder="Add details..." class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-4 py-3 text-base focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition resize-none"></textarea>
                </div>
            </div>
            <div class="mt-4 pt-2 border-t border-gray-100 dark:border-gray-800 shrink-0">
                 <button onclick="saveTask()" id="taskSaveBtn" class="w-full bg-ios-blue text-white py-4 rounded-2xl font-bold text-base hover:bg-blue-600 transition shadow-lg shadow-blue-500/30">Create Task</button>
            </div>
        </div>
    </div>

    <!-- View Task Modal (Mobile Optimized) -->
    <div id="viewTaskModal" class="fixed inset-0 z-[200] hidden flex items-end md:items-center justify-center bg-black/50 backdrop-blur-sm transition-all duration-300 pt-10">
        <div class="bg-white dark:bg-[#1c1c1e] rounded-t-3xl md:rounded-3xl w-full max-w-md p-6 shadow-2xl relative animate-slide-up-mobile md:animate-fade-in gpu-accel flex flex-col max-h-[85vh] pb-safe">
            <div class="w-12 h-1 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-4 md:hidden"></div>
            <div class="flex justify-between items-start mb-4">
                <div class="pr-8">
                    <h2 class="text-xl font-bold dark:text-white leading-tight break-words" id="viewTaskTitle">Task Title</h2>
                    <div class="flex items-center gap-3 mt-2">
                        <span id="viewTaskPriority" class="text-[10px] font-bold uppercase px-2 py-0.5 rounded-md bg-gray-100 text-gray-500">Normal</span>
                        <span id="viewTaskDate" class="text-xs text-gray-400 font-medium"><i class="fa-regular fa-calendar mr-1"></i> Date</span>
                    </div>
                </div>
                <button onclick="closeViewTaskModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-white/20 transition shrink-0 absolute right-6 top-6"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="w-full h-px bg-gray-100 dark:bg-gray-700 my-2"></div>
            <div class="overflow-y-auto custom-scrollbar flex-grow min-h-[100px] task-desc text-sm dark:text-gray-200" id="viewTaskDesc">
                <!-- Content injected here -->
            </div>
             <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-800 shrink-0">
                <button onclick="closeViewTaskModal()" class="w-full bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white py-3.5 rounded-xl font-bold hover:bg-gray-200 dark:hover:bg-white/20 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="fixed inset-0 z-[100] flex items-center justify-center bg-ios-light dark:bg-black p-6 animate-fade-in">
        <div class="w-full max-w-sm transition-all duration-300" id="authContainer">
            <div class="text-center mb-10">
                <div class="w-20 h-20 rounded-[2rem] bg-gradient-to-br from-ios-blue to-ios-purple text-white flex items-center justify-center shadow-2xl mx-auto mb-6">
                    <i class="fa-solid fa-wallet text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold tracking-tight mb-2">ProTracker</h1>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Your Personal Cloud Wallet</p>
            </div>
            
            <div id="splashLoader" class="hidden flex flex-col items-center justify-center py-8 animate-fade-in">
                <div class="w-12 h-12 border-4 border-gray-200 dark:border-gray-800 border-t-ios-blue rounded-full animate-spin mb-4"></div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest animate-pulse-slow">Securely Syncing...</p>
            </div>

            <div id="authStep1" class="glass rounded-3xl p-8 shadow-lg border border-white/50 dark:border-white/10 hover-lift gpu-accel">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">Username</label>
                        <input type="text" id="usernameInput" placeholder="Enter username" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-5 py-4 text-base font-bold focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition placeholder:font-normal placeholder:text-gray-400">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">PIN Code</label>
                        <input type="tel" maxlength="4" id="loginPinInput" placeholder="â€¢â€¢â€¢â€¢" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-5 py-4 text-2xl text-center font-bold tracking-[0.5em] focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition placeholder:tracking-widest">
                    </div>
                </div>
                <div id="authLoader" class="hidden flex justify-center mt-4"><div class="loader !border-gray-400 !border-l-ios-blue"></div></div>
                <button onclick="loginUser()" id="loginBtn" class="w-full bg-ios-blue text-white py-4 rounded-2xl font-bold text-base mt-6 hover:bg-blue-600 transition shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">Login</button>
                <div class="mt-6 text-center">
                    <button onclick="showRegisterStep()" class="text-xs font-bold text-gray-500 hover:text-ios-blue dark:text-gray-400 dark:hover:text-white transition">New here? Create Account</button>
                </div>
            </div>

            <div id="authStepRegister" class="hidden glass rounded-3xl p-8 shadow-lg border border-white/50 dark:border-white/10 hover-lift gpu-accel">
                <div class="flex items-center mb-4 cursor-pointer text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition" onclick="resetAuth()">
                    <i class="fa-solid fa-arrow-left mr-2"></i> <span class="text-xs font-bold uppercase">Back to Login</span>
                </div>
                <h2 class="text-xl font-bold mb-1">Create Account</h2>
                <div id="regStepUsername">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">Username</label>
                    <input type="text" id="regUsernameInput" placeholder="Choose username" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-5 py-4 text-base font-bold focus:ring-2 focus:ring-ios-purple outline-none dark:text-white transition placeholder:font-normal placeholder:text-gray-400 mb-4">
                    <button onclick="checkRegistrationUsername()" id="checkUserBtn" class="w-full bg-gray-200 dark:bg-white/10 text-gray-700 dark:text-white py-4 rounded-2xl font-bold text-base hover:bg-gray-300 dark:hover:bg-white/20 transition">Check Availability</button>
                </div>
                <div id="regStepPin" class="hidden">
                    <p class="text-sm text-ios-green font-bold mb-4 flex items-center"><i class="fa-solid fa-check-circle mr-2"></i> Username available</p>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">Create 4-Digit PIN</label>
                    <input type="tel" maxlength="4" id="regPinInput" placeholder="â€¢â€¢â€¢â€¢" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-5 py-4 text-2xl text-center font-bold tracking-[0.5em] focus:ring-2 focus:ring-ios-purple outline-none dark:text-white transition placeholder:tracking-widest">
                    <button onclick="completeRegistration()" id="createAccBtn" class="w-full bg-ios-purple text-white py-4 rounded-2xl font-bold text-base mt-6 hover:bg-purple-600 transition shadow-lg shadow-purple-500/30">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP UI -->
    <div id="appUI" class="hidden flex-col h-[100dvh]">
        <nav class="fixed top-0 w-full z-[90] glass border-b border-gray-200 dark:border-gray-800 transition-colors duration-300 pt-safe pt-6 gpu-accel">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center gap-2 animate-float-in">
                        <button onclick="toggleAppMode()" class="w-10 h-10 rounded-full bg-black dark:bg-white text-white dark:text-black flex items-center justify-center shadow-lg hover:scale-105 transition-transform active:scale-95" title="Switch Mode">
                            <i id="navIconMain" class="fa-solid fa-wallet text-sm"></i>
                        </button>
                        <div class="flex flex-col">
                            <span class="font-bold text-lg tracking-tight leading-none" id="appTitle">ProTracker</span>
                            <span class="text-[10px] text-gray-500 dark:text-gray-400 font-medium" id="appSubtitle">Dashboard</span>
                        </div>
                        <div onclick="editExchangeRate()" class="md:hidden bg-gray-100 dark:bg-white/10 px-3 py-1.5 rounded-full flex items-center gap-1.5 cursor-pointer border border-gray-200 dark:border-gray-700 ml-1" id="rateMobileBadge">
                            <i class="fa-solid fa-money-bill-transfer text-ios-blue text-[9px]"></i>
                            <span id="rateDisplayMobile" class="font-bold text-[10px] text-ios-blue">...</span>
                        </div>
                    </div>
                    
                    <div class="absolute left-1/2 transform -translate-x-1/2 hidden md:flex items-center justify-center animate-float-in w-max" id="rateDesktopBadge">
                        <div onclick="editExchangeRate()" class="bg-gray-100 dark:bg-white/10 px-4 py-2 rounded-full flex items-center gap-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-white/20 transition shadow-sm border border-gray-200 dark:border-gray-700 group">
                            <i class="fa-solid fa-money-bill-transfer text-ios-blue text-[10px] group-hover:rotate-180 transition-transform duration-500"></i>
                            <span id="rateDisplay" class="font-bold text-xs text-ios-blue">Loading...</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 animate-float-in z-50" style="animation-delay: 0.1s;">
                        <div class="relative" id="notifContainer">
                            <button onclick="toggleNotifications(event)" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition relative" aria-label="Notifications">
                                <i class="fa-regular fa-bell"></i>
                                <span id="notifBadge" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-white dark:border-black rounded-full hidden"></span>
                            </button>
                            <div id="notifBackdrop" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-[100] transition-opacity opacity-0 pointer-events-none md:hidden" onclick="toggleNotifications(event)"></div>
                            <div id="notifDropdown" class="hidden fixed inset-x-0 bottom-0 top-auto m-0 z-[110] bg-white dark:bg-[#1c1c1e] shadow-[0_-4px_20px_rgba(0,0,0,0.1)] dark:shadow-[0_-4px_20px_rgba(0,0,0,0.4)] rounded-t-3xl border-t border-gray-100 dark:border-gray-800 transform transition-all duration-300 ease-out translate-y-full flex flex-col max-h-[75vh] pb-safe md:absolute md:inset-auto md:top-full md:right-0 md:mt-3 md:w-96 md:max-h-[32rem] md:rounded-2xl md:shadow-2xl md:border md:origin-top-right md:translate-y-0 md:scale-95 md:opacity-0 md:pointer-events-none">
                                <div class="w-full flex justify-center pt-3 pb-1 md:hidden" onclick="toggleNotifications(event)"><div class="w-10 h-1 bg-gray-300 dark:bg-gray-600 rounded-full"></div></div>
                                <div class="px-5 py-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-white dark:bg-[#1c1c1e] md:rounded-t-2xl shrink-0 sticky top-0 z-10">
                                    <h3 class="text-base font-bold dark:text-white flex items-center gap-2">Notifications <span id="notifCount" class="text-[10px] bg-ios-blue/10 text-ios-blue px-2 py-0.5 rounded-full hidden">0</span></h3>
                                    <button onclick="clearAllNotifications()" class="text-xs text-ios-blue font-semibold hover:text-blue-600 transition">Clear All</button>
                                </div>
                                <div id="notifList" class="overflow-y-auto custom-scrollbar flex-grow p-2 space-y-1 min-h-[150px]"></div>
                                <div id="notifEmpty" class="py-12 text-center hidden shrink-0"><div class="w-12 h-12 bg-gray-50 dark:bg-white/5 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fa-regular fa-bell-slash text-gray-300 dark:text-gray-600 text-xl"></i></div><p class="text-sm font-medium text-gray-900 dark:text-white">No notifications</p></div>
                            </div>
                        </div>
                        <button onclick="toggleCurrency()" class="w-9 h-9 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center text-[10px] font-bold hover:bg-gray-300 dark:hover:bg-gray-700 transition active:scale-95 text-ios-blue" aria-label="Toggle Currency"><span id="currencyLabel">VND</span></button>
                        <div class="relative">
                            <button onclick="openSettingsModal()" class="w-9 h-9 rounded-full bg-gradient-to-br from-ios-blue to-ios-purple text-white flex items-center justify-center hover:opacity-90 transition shadow-md overflow-hidden ring-2 ring-white dark:ring-black" aria-label="Settings">
                                <img id="navbarAvatar" src="https://img.icons8.com/fluency/96/user-male-circle.png" class="w-full h-full object-cover hidden">
                                <i id="navbarIcon" class="fa-solid fa-user text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow pt-safe-offset pb-20 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto w-full overflow-y-auto custom-scrollbar pb-safe relative">
            
            <!-- FINANCE DASHBOARD -->
            <div id="financeView" class="space-y-6 transition-all duration-300">
                <div class="flex items-center justify-center gap-2 py-2 animate-float-in">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 transition active:scale-90" aria-label="Previous Month"><i class="fa-solid fa-chevron-left text-ios-blue text-xs"></i></button>
                    <h2 id="currentMonthDisplay" class="text-lg font-bold w-36 text-center">October 2023</h2>
                    <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 transition active:scale-90" aria-label="Next Month"><i class="fa-solid fa-chevron-right text-ios-blue text-xs"></i></button>
                    <button onclick="jumpToToday()" class="text-xs text-ios-blue font-semibold absolute right-4 sm:relative sm:right-auto hover:underline">Today</button>
                </div>
                <div id="lockedMessage" class="hidden text-center animate-float-in"><span class="inline-block bg-gray-100 dark:bg-gray-800 text-gray-500 text-[10px] uppercase font-bold px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700 shadow-sm"><i class="fa-solid fa-lock mr-1"></i> Read Only Mode</span></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Income -->
                    <div class="glass rounded-3xl p-5 relative overflow-hidden group hover-lift transition-all duration-300 border-0 shadow-lg dark:shadow-none bg-gradient-to-br from-white to-green-50 dark:from-[#1c1c1e] dark:to-green-900/10">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                             <i class="fa-solid fa-arrow-trend-up text-6xl text-ios-green"></i>
                        </div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div class="flex justify-between items-start">
                                 <div class="bg-green-100 dark:bg-green-500/20 w-10 h-10 rounded-full flex items-center justify-center text-ios-green mb-3">
                                    <i class="fa-solid fa-arrow-down rotate-180"></i>
                                </div>
                                 <div class="cursor-pointer" onclick="toggleStatsView()">
                                    <span id="viewModeBadge" class="text-[10px] font-bold px-2 py-1 rounded-full bg-white/80 dark:bg-black/50 backdrop-blur-sm border border-black/5 dark:border-white/10 shadow-sm">Mo</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1" id="lblIncome">Income</p>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight" id="incomeDisplay">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Spent -->
                    <div class="glass rounded-3xl p-5 relative overflow-hidden group hover-lift transition-all duration-300 border-0 shadow-lg dark:shadow-none bg-gradient-to-br from-white to-red-50 dark:from-[#1c1c1e] dark:to-red-900/10">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                             <i class="fa-solid fa-arrow-trend-down text-6xl text-ios-red"></i>
                        </div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                             <div class="bg-red-100 dark:bg-red-500/20 w-10 h-10 rounded-full flex items-center justify-center text-ios-red mb-3">
                                <i class="fa-solid fa-arrow-down"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1" id="lblSpent">Spent</p>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight" id="spentDisplay">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Net Worth -->
                    <div class="glass rounded-3xl p-5 relative overflow-hidden group hover-lift transition-all duration-300 border-0 shadow-lg dark:shadow-none bg-gradient-to-br from-white to-teal-50 dark:from-[#1c1c1e] dark:to-teal-900/10">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                             <i class="fa-solid fa-wallet text-6xl text-ios-teal"></i>
                        </div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                             <div class="bg-teal-100 dark:bg-teal-500/20 w-10 h-10 rounded-full flex items-center justify-center text-ios-teal mb-3">
                                <i class="fa-solid fa-sack-dollar"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Net Worth</p>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight" id="walletDisplay">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Left -->
                    <div class="glass rounded-3xl p-5 relative overflow-hidden group hover-lift transition-all duration-300 border-0 shadow-lg dark:shadow-none bg-gradient-to-br from-white to-blue-50 dark:from-[#1c1c1e] dark:to-blue-900/10">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                             <i class="fa-solid fa-chart-pie text-6xl text-ios-blue"></i>
                        </div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                             <div class="bg-blue-100 dark:bg-blue-500/20 w-10 h-10 rounded-full flex items-center justify-center text-ios-blue mb-3">
                                <i class="fa-solid fa-scale-balanced"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Budget Left</p>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight" id="monthlyLeftDisplay">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 items-start">
                    <div class="flex flex-col gap-6">
                        <div class="glass rounded-3xl shadow-sm p-6 flex flex-col animate-float-in hover-lift gpu-accel">
                            <div class="flex justify-between items-start mb-4"><div><h2 class="text-lg font-bold">Assets</h2><p class="text-[10px] text-gray-400">Balances</p></div><span class="text-[10px] bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 px-2 py-1 rounded-full font-medium">Continuous</span></div>
                            <div class="flex flex-col items-center gap-6">
                                <div class="relative w-48 h-48 flex flex-col items-center justify-center"><canvas id="bankWheel"></canvas><div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><span class="text-xs text-gray-400 font-bold uppercase tracking-wider">Bank</span><span class="font-bold text-ios-blue text-lg" id="centerBankBalance">0</span></div></div>
                                <div class="flex items-center justify-center gap-4 w-full bg-gray-5 dark:bg-white/5 p-3 rounded-2xl border border-gray-100 dark:border-gray-800"><div class="relative w-16 h-16 flex-shrink-0"><canvas id="cashWheel"></canvas></div><div class="flex flex-col"><span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Cash Wallet</span><span class="font-bold text-ios-green text-base" id="centerCashBalance">0</span></div></div>
                            </div>
                            <div class="w-full h-px bg-gray-100 dark:bg-gray-800 my-4"></div>
                            <div class="flex justify-center gap-4 text-xs text-center"><div><span class="block text-gray-400">All Income</span><span class="font-bold text-ios-green" id="footerTotalIncome">0</span></div><div class="w-px bg-gray-200 dark:bg-gray-700"></div><div><span class="block text-gray-400">All Out</span><span class="font-bold text-ios-red" id="footerTotalSpent">0</span></div></div>
                        </div>
                        <div class="glass rounded-3xl shadow-sm p-6 flex flex-col animate-float-in hover-lift gpu-accel">
                            <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold flex items-center"><i class="fa-solid fa-repeat mr-2 text-ios-purple"></i>Subscriptions</h2><button onclick="window.openSubscriptionModal()" id="addSubBtn" class="text-xs bg-ios-purple/10 text-ios-purple px-3 py-1.5 rounded-full font-bold hover:bg-ios-purple/20 transition">+ Add</button></div>
                            <div class="flex-grow overflow-y-auto max-h-[350px] pr-1 space-y-2 custom-scrollbar" id="subscriptionList"></div>
                            <div id="emptySubs" class="hidden text-center text-gray-400 text-xs py-4">No subscriptions.</div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-6">
                        <div class="glass rounded-3xl shadow-sm p-6 flex flex-col animate-float-in hover-lift gpu-accel">
                            <div class="flex justify-between items-start mb-4"><div><h2 class="text-lg font-bold">Monthly Limit</h2><p class="text-[10px] text-gray-400">General Spending</p></div></div>
                            <div id="limitControl" class="mb-4 flex gap-2"><input type="text" inputmode="numeric" id="limitInput" onkeyup="formatCurrencyInput(this)" placeholder="Set General Limit" class="flex-grow bg-gray-100 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-2 text-base focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition"><button onclick="setMonthLimit()" class="bg-ios-blue text-white px-4 rounded-xl text-sm font-semibold hover:bg-blue-600 transition shadow-lg shadow-blue-500/30">Set</button></div>
                            <div class="flex-grow flex items-center justify-center relative min-h-[200px]"><div class="relative w-52 h-52"><canvas id="budgetWheel"></canvas><div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none p-4 text-center"><span class="text-xs text-gray-400 font-medium">Available</span><span class="text-xl font-bold text-ios-blue break-all" id="centerBudgetRemaining">0</span><span class="text-[10px] text-gray-400 mt-1" id="centerLimitLabel">Limit: 0</span></div></div></div>
                        </div>
                        <div class="glass rounded-3xl shadow-sm p-6 animate-float-in hover-lift gpu-accel">
                            <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold flex items-center"><i class="fa-solid fa-list-check text-ios-purple mr-2"></i>Sub-Limits</h2><button onclick="window.openSubLimitModal()" class="text-xs bg-ios-purple/10 text-ios-purple px-3 py-1.5 rounded-full font-bold hover:bg-ios-purple/20 transition">+ Add</button></div>
                            <div id="subLimitsContainer" class="grid grid-cols-1 gap-3"></div>
                            <div id="emptySubLimits" class="hidden text-center text-gray-400 text-xs py-4">No sub-limits created.</div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-6">
                        <div class="glass rounded-3xl shadow-sm p-6 animate-float-in hover-lift gpu-accel">
                            <h2 class="text-lg font-bold mb-4">Add Transaction</h2>
                            <div id="transControl" class="flex flex-col gap-4">
                                <div class="bg-gray-100 dark:bg-gray-800 p-1 rounded-xl flex">
                                    <button onclick="window.setTransactionAccount('bank')" id="btnAcctBank" class="flex-1 py-2 rounded-lg text-xs font-bold transition bg-white dark:bg-gray-700 text-black dark:text-white shadow-sm">Bank</button>
                                    <button onclick="window.setTransactionAccount('cash')" id="btnAcctCash" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-gray-500 dark:text-gray-400">Cash</button>
                                </div>
                                <input type="text" id="descInput" placeholder="Description" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl px-4 py-4 text-base focus:ring-2 focus:ring-ios-blue outline-none transition dark:text-white">
                                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold" id="inputCurrencySymbol">â‚«</span><input type="text" inputmode="numeric" id="amountInput" onkeyup="formatCurrencyInput(this)" placeholder="0" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl pl-8 pr-4 py-4 text-xl font-bold focus:ring-2 focus:ring-ios-blue outline-none transition dark:text-white"></div>
                                <div class="relative flex gap-2">
                                    <input list="categoryList" id="categoryInput" placeholder="Category" class="flex-grow bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 text-base focus:ring-2 focus:ring-ios-blue outline-none transition dark:text-white">
                                    <datalist id="categoryList"></datalist>
                                    <button onclick="window.openCategoryModal()" class="bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-gray-300 w-12 rounded-xl flex items-center justify-center hover:bg-gray-200 dark:hover:bg-white/20 transition group"><i class="fa-solid fa-list text-sm"></i></button>
                                </div>
                                <div><label class="block text-[10px] text-gray-500 mb-1 ml-1 font-semibold uppercase">Budget Source</label><select id="budgetSelect" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 text-base focus:ring-2 focus:ring-ios-blue outline-none transition dark:text-white appearance-none cursor-pointer"><option value="general">General (Monthly Limit)</option></select></div>
                                <div class="grid grid-cols-3 gap-2 mt-2">
                                    <button onclick="window.addTransaction('expense')" id="btnExpense" class="bg-ios-red text-white py-4 rounded-2xl font-semibold hover:bg-red-600 transition active:scale-95 shadow-lg shadow-red-500/30 flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-arrow-down"></i> <span class="text-xs">Spent</span></button>
                                    <button onclick="window.addTransaction('transfer')" id="btnTransfer" class="bg-ios-blue text-white py-4 rounded-2xl font-semibold hover:bg-blue-600 transition active:scale-95 shadow-lg shadow-blue-500/30 flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-right-left"></i> <span class="text-xs">Transfer</span></button>
                                    <button onclick="window.addTransaction('revenue')" id="btnRevenue" class="bg-ios-green text-white py-4 rounded-2xl font-semibold hover:bg-green-600 transition active:scale-95 shadow-lg shadow-green-500/30 flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-arrow-up"></i> <span class="text-xs">Income</span></button>
                                </div>
                            </div>
                        </div>
                        <div class="glass rounded-3xl shadow-sm p-6 animate-float-in hover-lift flex-grow gpu-accel">
                             <div class="mb-4 space-y-2">
                                <div class="flex justify-between items-center"><h2 class="text-lg font-bold">History <span class="text-xs font-normal text-gray-500 ml-2" id="historyMonthLabel"></span></h2></div>
                                <div class="flex gap-2">
                                    <div class="relative flex-grow"><i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i><input type="text" placeholder="Search..." onkeyup="handleSearch(this.value)" class="w-full bg-gray-100 dark:bg-white/10 border-none rounded-xl pl-8 pr-3 py-2 text-xs font-bold focus:ring-2 focus:ring-ios-blue outline-none dark:text-white transition"></div>
                                    <select onchange="updateSort(this.value)" class="bg-gray-100 dark:bg-white/10 border-none rounded-xl text-xs font-bold px-3 py-2 focus:ring-0 cursor-pointer dark:text-white w-24"><option value="newest">Newest</option><option value="oldest">Oldest</option><option value="high">High</option></select>
                                </div>
                            </div>
                            <ul id="historyList" class="space-y-3 max-h-[500px] overflow-y-auto custom-scrollbar pr-1"></ul>
                        </div>
                    </div>
                </div>
                <div class="glass rounded-3xl shadow-sm p-6 animate-float-in mb-8 hover-lift gpu-accel">
                    <h2 class="text-lg font-bold mb-4">6-Month Overview</h2>
                    <div class="overflow-x-auto custom-scrollbar"><table class="w-full text-left border-collapse"><thead><tr class="text-xs text-gray-400 uppercase tracking-wide border-b border-gray-200 dark:border-gray-700"><th class="pb-3 pl-2">Month</th><th class="pb-3 text-right">Income</th><th class="pb-3 text-right">Spent</th><th class="pb-3 text-right">Savings</th></tr></thead><tbody id="comparisonTableBody" class="text-sm font-medium"></tbody></table></div>
                </div>
            </div>

            <!-- TASK BOARD VIEW -->
            <div id="tasksView" class="hidden space-y-6 animate-fade-in pb-20">
                <!-- Header & Progress (No longer sticky to fix scroll issues) -->
                <div class="glass rounded-3xl p-6 shadow-sm flex flex-col md:flex-row items-center gap-6 justify-between relative z-20">
                    <div class="w-full md:w-auto">
                        <h2 class="text-2xl font-bold dark:text-white">Task Board</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium" id="taskCurrentDate">Monday, Oct 24</p>
                    </div>
                    <div class="flex-grow w-full md:max-w-md">
                        <div class="flex justify-between text-xs font-bold mb-2 text-gray-500 dark:text-gray-400">
                            <span>Progress</span>
                            <span id="taskProgressLabel">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                            <div id="taskProgressBar" class="bg-ios-blue h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <button onclick="openTaskModal()" class="w-full md:w-auto bg-ios-blue text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> New Task
                    </button>
                </div>

                <!-- Kanban Columns -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-h-[500px]">
                    <!-- Column: Upcoming -->
                    <div class="flex flex-col h-full bg-gray-50/50 dark:bg-[#1c1c1e] border border-gray-100 dark:border-gray-800 rounded-3xl overflow-hidden shadow-sm">
                        <!-- Header -->
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-white/50 dark:bg-white/5 backdrop-blur-sm relative overflow-hidden">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gray-300 dark:bg-gray-600"></div>
                            <div class="flex items-center gap-2 pl-2">
                                <h3 class="font-bold text-gray-700 dark:text-gray-200 text-sm tracking-wide uppercase">To Do</h3>
                            </div>
                            <span id="countUpcoming" class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-2.5 py-1 rounded-lg">0</span>
                        </div>
                        <!-- Content -->
                        <div id="col-upcoming" class="flex-grow p-3 space-y-3 overflow-y-auto custom-scrollbar bg-gray-50/30 dark:bg-transparent min-h-[150px] relative transition-colors duration-200">
                            <!-- Tasks injected here -->
                        </div>
                    </div>

                    <!-- Column: In Progress -->
                    <div class="flex flex-col h-full bg-blue-50/30 dark:bg-[#1a202e] border border-blue-100 dark:border-blue-900/30 rounded-3xl overflow-hidden shadow-sm">
                         <!-- Header -->
                         <div class="p-4 border-b border-blue-100 dark:border-blue-900/30 flex justify-between items-center bg-blue-50/50 dark:bg-blue-900/10 backdrop-blur-sm relative overflow-hidden">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-ios-blue"></div>
                            <div class="flex items-center gap-2 pl-2">
                                <h3 class="font-bold text-blue-700 dark:text-blue-400 text-sm tracking-wide uppercase">In Progress</h3>
                            </div>
                             <span id="countInProgress" class="bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300 text-xs font-bold px-2.5 py-1 rounded-lg">0</span>
                        </div>
                        <div id="col-inprogress" class="flex-grow p-3 space-y-3 overflow-y-auto custom-scrollbar bg-transparent min-h-[150px] relative transition-colors duration-200">
                            <!-- Tasks injected here -->
                        </div>
                    </div>

                    <!-- Column: Done -->
                    <div class="flex flex-col h-full bg-green-50/30 dark:bg-[#1a2e20] border border-green-100 dark:border-green-900/30 rounded-3xl overflow-hidden shadow-sm">
                         <!-- Header -->
                         <div class="p-4 border-b border-green-100 dark:border-green-900/30 flex justify-between items-center bg-green-50/50 dark:bg-green-900/10 backdrop-blur-sm relative overflow-hidden">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-ios-green"></div>
                            <div class="flex items-center gap-2 pl-2">
                                <h3 class="font-bold text-green-700 dark:text-green-400 text-sm tracking-wide uppercase">Done</h3>
                            </div>
                             <span id="countDone" class="bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-300 text-xs font-bold px-2.5 py-1 rounded-lg">0</span>
                        </div>
                        <div id="col-done" class="flex-grow p-3 space-y-3 overflow-y-auto custom-scrollbar bg-transparent min-h-[150px] relative transition-colors duration-200">
                            <!-- Tasks injected here -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Settings Modal (Mobile Optimized) -->
    <div id="settingsModal" class="fixed inset-0 z-[150] hidden flex items-end md:items-center justify-center bg-black/50 backdrop-blur-sm transition-all duration-300 pt-10">
        <div class="bg-white dark:bg-[#1c1c1e] rounded-t-3xl md:rounded-3xl w-full max-w-md p-6 shadow-2xl relative animate-slide-up-mobile md:animate-fade-in max-h-[90vh] overflow-y-auto custom-scrollbar gpu-accel pb-safe">
            <div class="w-12 h-1 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-6 md:hidden"></div>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Settings</h2>
                <button onclick="closeSettingsModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-white/20 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex flex-col items-center mb-8">
                <div class="relative group">
                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-ios-blue to-ios-purple p-1 shadow-lg overflow-hidden">
                        <div class="w-full h-full rounded-full bg-white dark:bg-black overflow-hidden flex items-center justify-center relative">
                            <img id="settingsAvatar" src="https://img.icons8.com/fluency/96/user-male-circle.png" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" onclick="document.getElementById('avatarInput').click()"><i class="fa-solid fa-camera text-white"></i></div>
                        </div>
                    </div>
                    <button onclick="removeAvatar()" class="absolute bottom-0 right-0 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md hover:bg-red-600 transition" title="Remove Photo"><i class="fa-solid fa-trash text-xs"></i></button>
                    <input type="file" id="avatarInput" class="hidden" accept="image/*" onchange="handleAvatarUpload(this)">
                </div>
                <h3 class="mt-3 text-lg font-bold dark:text-white" id="settingsUsername">User</h3>
                <p class="text-xs text-gray-500">Finance Tracker User</p>
            </div>
            <div class="space-y-3">
                <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-2">
                    <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-white/10 transition">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-ios-purple/20 text-ios-purple flex items-center justify-center"><i class="fa-solid fa-moon"></i></div><span class="text-sm font-bold dark:text-white">Dark Mode</span></div>
                        <i class="fa-solid fa-toggle-on text-2xl text-ios-green dark:text-gray-600" id="themeToggleIcon"></i>
                    </button>
                    <button onclick="openChangePinModal()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-white/10 transition mt-1">
                         <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-ios-blue/20 text-ios-blue flex items-center justify-center"><i class="fa-solid fa-shield-halved"></i></div><span class="text-sm font-bold dark:text-white">Change PIN</span></div>
                        <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
                    </button>
                </div>
                
                <!-- Data Import/Export Section -->
                <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-2">
                     <button onclick="exportData()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-white/10 transition">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-ios-teal/20 text-ios-teal flex items-center justify-center"><i class="fa-solid fa-download"></i></div><span class="text-sm font-bold dark:text-white">Export Data</span></div>
                    </button>
                    <button onclick="document.getElementById('importInput').click()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-white/10 transition mt-1">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-ios-orange/20 text-ios-orange flex items-center justify-center"><i class="fa-solid fa-file-import"></i></div><span class="text-sm font-bold dark:text-white">Import Data</span></div>
                    </button>
                    <!-- Bank CSV Import -->
                    <button onclick="document.getElementById('bankCsvInput').click()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-white/10 transition mt-1">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-building-columns"></i></div><span class="text-sm font-bold dark:text-white">Import Bank Statement (CSV)</span></div>
                    </button>
                    <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(this)">
                    <input type="file" id="bankCsvInput" class="hidden" accept=".csv" onchange="handleBankImport(this)">
                </div>

                <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-4">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Activity Security</h4>
                    <div id="securityLogsList" class="space-y-3 max-h-40 overflow-y-auto custom-scrollbar"><p class="text-xs text-gray-400 text-center">No recent activity.</p></div>
                </div>
                <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-2">
                     <button onclick="requestNotificationPermission()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-white/10 transition">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-ios-orange/20 text-ios-orange flex items-center justify-center"><i class="fa-solid fa-bell"></i></div><span class="text-sm font-bold dark:text-white">Enable Notifications</span></div>
                    </button>
                    <button onclick="handleLogout()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-white/10 transition mt-1">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center justify-center"><i class="fa-solid fa-arrow-right-from-bracket"></i></div><span class="text-sm font-bold dark:text-white">Logout</span></div>
                    </button>
                     <button onclick="handleDeleteAccount()" class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition mt-1 group">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-500/20 text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash"></i></div><span class="text-sm font-bold text-red-500">Delete Account</span></div>
                    </button>
                </div>
                <p class="text-center text-[10px] text-gray-400 mt-4">App Version 2.6.4 (Scroll Fix)</p>
            </div>
        </div>
    </div>

    <!-- PIN Change/Create Modal (Generic) -->
    <div id="pinModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/60 backdrop-blur-md p-4 transition-all duration-300">
        <div class="bg-white dark:bg-[#1c1c1e] rounded-3xl w-full max-w-xs p-6 shadow-2xl text-center gpu-accel">
            <h3 class="text-lg font-bold mb-2 dark:text-white" id="pinModalTitle">Set PIN Code</h3>
            <p class="text-sm text-gray-500 mb-6" id="pinModalDesc">Create a 4-digit code for security.</p>
            <input type="tel" maxlength="4" id="genericPinInput" placeholder="â€¢â€¢â€¢â€¢" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-5 py-4 text-2xl text-center font-bold tracking-[0.5em] focus:ring-2 focus:ring-ios-blue outline-none dark:text-white mb-6 transition placeholder:tracking-widest">
            <div class="flex gap-2">
                <button onclick="closePinModal()" class="flex-1 bg-gray-100 dark:bg-white/10 text-gray-600 dark:text-gray-300 py-3 rounded-xl font-bold">Cancel</button>
                <button onclick="submitGenericPin()" class="flex-1 bg-ios-blue text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30">Save</button>
            </div>
        </div>
    </div>

    <!-- Legacy Account PIN Prompt Modal (Force) -->
    <div id="legacyPinModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="bg-white dark:bg-[#1c1c1e] rounded-3xl w-full max-w-xs p-8 shadow-2xl text-center gpu-accel">
             <div class="w-16 h-16 rounded-full bg-ios-orange/20 text-ios-orange flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-shield-halved text-2xl"></i></div>
            <h3 class="text-xl font-bold mb-2 dark:text-white">Security Update</h3>
            <p class="text-sm text-gray-500 mb-6">We've added PIN protection. Please create a 4-digit code to secure your existing account.</p>
            <input type="tel" maxlength="4" id="legacyPinInput" placeholder="â€¢â€¢â€¢â€¢" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-2xl px-5 py-4 text-2xl text-center font-bold tracking-[0.5em] focus:ring-2 focus:ring-ios-orange outline-none dark:text-white mb-6 transition placeholder:tracking-widest">
            <button onclick="saveLegacyPin()" class="w-full bg-ios-orange text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-500/30">Secure Account</button>
        </div>
    </div>

    <script>
        // SHA-256 Hashing helper
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Simple HTML Escape helper
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBLLUnNGyFxJFEJXOTZ42tAgo41rylZEpA",
            authDomain: "baowalletapp.firebaseapp.com",
            projectId: "baowalletapp",
            storageBucket: "baowalletapp.firebasestorage.app",
            messagingSenderId: "973567102982",
            appId: "1:973567102982:web:1b5abf693464c03e85f387"
        };
        
        // Use a global placeholder for fb to avoid undefined errors if script fails or is slow
        if (typeof window.fb === 'undefined') window.fb = null;

        let db, auth, currentUserDocId = null, unsubscribeSnapshot = null;
        let exchangeRate = 26300, isManualRate = false, viewDate = new Date();
        let budgetChart, bankChart, cashChart, currentSort = 'newest', searchQuery = '', confirmCallback = null, pinCallback = null;
        let selectedTransAccount = 'bank';
        let statsViewMode = 'monthly';
        let cropper = null; 
        let appMode = 'finance'; // 'finance' or 'tasks'
        let editingTaskId = null;
        let appData = { 
            currency: 'VND', 
            limits: {}, 
            transactions: [], 
            subscriptions: [], 
            subLimits: [], 
            tasks: [], // { id, title, desc, date, priority, status }
            categories: ['Food', 'Transport', 'Utilities', 'Entertainment', 'Shopping', 'Health', 'Education', 'Bill', 'Exchange'], 
            customRate: null, 
            notifications: [],
            pin: null, 
            avatar: null, 
            securityLogs: [] 
        };
        // Offline queue
        let offlineQueue = [];
        
        const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        let editingSubLimitId = null;
        let editingSubId = null;
        let pendingUsername = '';
        let isInitialLoad = true;
        const notifiedIds = new Set(); 
        
        // Drag and Drop State (Unified)
        let dragClone = null;
        let dragStartPos = { x: 0, y: 0 };
        let isDragging = false;
        let currentDragId = null;
        let dragSourceEl = null;

        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : (FIREBASE_CONFIG.appId || 'default-app-id');

        function isCurrentViewMonth() {
            const now = new Date();
            return viewDate.getMonth() === now.getMonth() && viewDate.getFullYear() === now.getFullYear();
        }

        function getUserRef(username) {
            // Guard clause: Check if Firebase objects exist
            if (!window.fb || !db || !username) return null;
            const appIdToUse = typeof __app_id !== 'undefined' ? __app_id : (FIREBASE_CONFIG.appId || 'default-app-id');
            return window.fb.doc(db, 'artifacts', appIdToUse, 'public', 'data', 'finance_users', username);
        }

        function getDeviceModel() {
            const ua = navigator.userAgent;
            if (/iPhone/.test(ua)) return "iPhone";
            if (/iPad/.test(ua)) return "iPad";
            if (/Mac/.test(ua)) return "Mac";
            if (/Android/.test(ua)) return "Android Device";
            if (/Windows/.test(ua)) return "Windows PC";
            return "Unknown Device";
        }

        async function init() {
            loadTheme();
            
            try {
                const q = localStorage.getItem('finTrack_offlineQueue');
                if (q) offlineQueue = JSON.parse(q);
            } catch(e) {}

            const storedUser = localStorage.getItem('finTrack_username');
            let isAutoLoggedIn = false;

            const uIn = document.getElementById('usernameInput');
            const pIn = document.getElementById('loginPinInput');
            if(uIn) uIn.value = '';
            if(pIn) pIn.value = '';

            if (storedUser) {
                const cachedData = localStorage.getItem('finTrack_data');
                if (cachedData) {
                    try {
                        const parsed = JSON.parse(cachedData);
                        if (parsed && typeof parsed === 'object') {
                            appData = { ...appData, ...parsed }; 
                            if(!Array.isArray(appData.subLimits)) appData.subLimits = [];
                            if(!Array.isArray(appData.transactions)) appData.transactions = [];
                            if(!Array.isArray(appData.subscriptions)) appData.subscriptions = [];
                            if(!Array.isArray(appData.tasks)) appData.tasks = [];
                            
                            document.getElementById('authScreen').classList.add('hidden');
                            document.getElementById('appUI').classList.remove('hidden');
                            document.getElementById('appUI').classList.add('flex');
                            document.getElementById('settingsUsername').innerText = storedUser;
                            currentUserDocId = storedUser; 
                            
                            if(appData.avatar) {
                                document.getElementById('navbarAvatar').src = appData.avatar;
                                document.getElementById('navbarAvatar').classList.remove('hidden');
                                document.getElementById('navbarIcon').classList.add('hidden');
                            }
                            
                            updateUI(); 
                            renderTasks();
                            showToast("Syncing...");
                        }
                    } catch(e) { console.error("Cache load failed", e); }
                } else {
                    document.getElementById('splashLoader').classList.remove('hidden');
                    document.getElementById('authStep1').classList.add('hidden');
                }
            } else {
                document.getElementById('splashLoader').classList.add('hidden');
                document.getElementById('authStep1').classList.remove('hidden');
            }

            // Wait for Firebase to load
            if (!window.isFirebaseReady) {
                await new Promise(r => window.addEventListener('firebaseLoaded', r));
            }
            
            let configToUse = FIREBASE_CONFIG;
            if (typeof __firebase_config !== 'undefined') { try { configToUse = JSON.parse(__firebase_config); } catch(e) {} }

            try {
                if(!configToUse.apiKey) throw new Error("Missing Config");
                // Initialize Firebase services here after we are sure window.fb is loaded
                if (window.fb) {
                    const app = window.fb.initializeApp(configToUse);
                    auth = window.fb.getAuth(app);
                    db = window.fb.getFirestore(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await window.fb.signInWithCustomToken(auth, __initial_auth_token);
                    else await window.fb.signInAnonymously(auth);

                    if (storedUser) {
                        await new Promise(resolve => {
                             const unsub = window.fb.onAuthStateChanged(auth, (user) => {
                                 if(user) resolve();
                                 unsub();
                             });
                        });
                        
                        // Safety check for DB
                        if (db) {
                            const userRef = getUserRef(storedUser);
                            if (userRef) {
                                const docSnap = await window.fb.getDoc(userRef);
                                if (docSnap.exists()) {
                                    await completeLogin(storedUser, false, true); 
                                    isAutoLoggedIn = true;
                                } else {
                                    localStorage.removeItem('finTrack_username');
                                    localStorage.removeItem('finTrack_data'); 
                                    handleLogout();
                                }
                            }
                        }
                    }
                }
            } catch (e) {
                console.error("Init Error:", e);
                if (!isAutoLoggedIn && !storedUser) {
                      document.getElementById('splashLoader').classList.add('hidden');
                      document.getElementById('authStep1').classList.remove('hidden');
                }
            }
            
            fetchLiveRate();
            setInterval(fetchLiveRate, 60000);
            window.addEventListener('online', () => { 
                showToast("Back Online"); 
                fetchLiveRate(); 
                processOfflineQueue();
            });
            window.addEventListener('offline', () => showToast("Offline Mode Enabled"));
            document.addEventListener("visibilitychange", () => {
                if (!document.hidden && currentUserDocId) {
                    fetchLiveRate();
                    console.log("App foregrounded, syncing...");
                }
            });

            initCharts();
            setStatsView('monthly');
            document.getElementById('taskDate').valueAsDate = new Date();
        }

        // --- TASK MANAGER ---
        
        function toggleAppMode() {
            appMode = appMode === 'finance' ? 'tasks' : 'finance';
            const finView = document.getElementById('financeView');
            const taskView = document.getElementById('tasksView');
            const navIcon = document.getElementById('navIconMain');
            const title = document.getElementById('appTitle');
            const subtitle = document.getElementById('appSubtitle');
            const rateBadge = document.getElementById('rateDesktopBadge');
            const rateMobile = document.getElementById('rateMobileBadge');

            if (appMode === 'tasks') {
                finView.classList.add('hidden');
                taskView.classList.remove('hidden');
                navIcon.className = "fa-solid fa-chart-pie text-sm";
                title.innerText = "Tasks";
                subtitle.innerText = "Kanban Board";
                rateBadge.classList.add('hidden');
                rateMobile.classList.add('hidden');
                renderTasks();
            } else {
                taskView.classList.add('hidden');
                finView.classList.remove('hidden');
                navIcon.className = "fa-solid fa-wallet text-sm";
                title.innerText = "ProTracker";
                subtitle.innerText = "Dashboard";
                rateBadge.classList.remove('hidden');
                rateMobile.classList.remove('hidden');
                // Re-render chart since display:none can glitch canvas
                updateUI();
            }
        }

        function formatTaskDescription(taskId, desc) {
            if (!desc) return '';
            let html = escapeHtml(desc);
            
            // Linkify URLs
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            html = html.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank" onclick="event.stopPropagation()">${url}</a>`;
            });

            // Checkboxes (Subtasks)
            const lines = html.split('\n');
            const processedLines = lines.map((line, index) => {
                if (/^-\s*\[\s*\]/.test(line)) {
                    const content = line.replace(/^-\s*\[\s*\]/, '').trim();
                    return `<div class="flex items-start"><input type="checkbox" onmousedown="event.stopPropagation()" onclick="toggleSubtask(${taskId}, ${index})" class="mt-1"><span class="${content ? '' : 'text-gray-400 italic'}">${content || 'Empty subtask'}</span></div>`;
                }
                if (/^-\s*\[x\]/i.test(line)) {
                    const content = line.replace(/^-\s*\[x\]/i, '').trim();
                    return `<div class="flex items-start"><input type="checkbox" checked onmousedown="event.stopPropagation()" onclick="toggleSubtask(${taskId}, ${index})" class="mt-1"><span class="line-through text-gray-500">${content}</span></div>`;
                }
                return line === '' ? '<br>' : `<div>${line}</div>`;
            });

            return processedLines.join('');
        }

        function toggleSubtask(taskId, lineIndex) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            const lines = task.desc.split('\n');
            if (lineIndex >= 0 && lineIndex < lines.length) {
                const line = lines[lineIndex];
                if (/^-\s*\[\s*\]/.test(line)) {
                    lines[lineIndex] = line.replace(/^-\s*\[\s*\]/, '- [x]');
                } else if (/^-\s*\[x\]/i.test(line)) {
                    lines[lineIndex] = line.replace(/^-\s*\[x\]/i, '- [ ]');
                }
                task.desc = lines.join('\n');
                saveData();
                renderTasks(); 
                const viewModal = document.getElementById('viewTaskModal');
                if(!viewModal.classList.contains('hidden')) {
                     document.getElementById('viewTaskDesc').innerHTML = formatTaskDescription(taskId, task.desc);
                }
            }
        }

        function renderTasks() {
            const today = new Date();
            document.getElementById('taskCurrentDate').innerText = `${dayNames[today.getDay()]}, ${monthNames[today.getMonth()]} ${today.getDate()}`;
            
            const cols = {
                upcoming: document.getElementById('col-upcoming'),
                inprogress: document.getElementById('col-inprogress'),
                done: document.getElementById('col-done')
            };
            
            Object.values(cols).forEach(c => c.innerHTML = '');
            
            let completed = 0;
            const tasks = appData.tasks || [];
            
            // Sort by priority (High > Medium > Low)
            const priorityVal = { 'high': 3, 'medium': 2, 'low': 1 };
            const sortedTasks = [...tasks].sort((a, b) => {
                const pa = priorityVal[a.priority] || 0;
                const pb = priorityVal[b.priority] || 0;
                return pb - pa;
            });
            
            sortedTasks.forEach(task => {
                const div = document.createElement('div');
                div.className = "bg-white dark:bg-[#2c2c2e] p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow task-card touch-none relative group";
                div.id = `task-${task.id}`;
                
                // Unified Drag Listeners
                div.onmousedown = (e) => startDrag(e, div, task.id);
                div.ontouchstart = (e) => startDrag(e, div, task.id);
                
                div.ondblclick = (e) => openViewTaskModal(task.id);
                
                let badgeColor = "bg-gray-100 text-gray-500";
                if(task.priority === 'high') badgeColor = "bg-red-100 text-red-500 dark:bg-red-500/20";
                else if(task.priority === 'medium') badgeColor = "bg-orange-100 text-orange-500 dark:bg-orange-500/20";
                
                const dateStr = task.date ? new Date(task.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}) : 'No Date';
                const formattedDesc = formatTaskDescription(task.id, task.desc);

                // Determine Move Buttons
                let moveBtns = '';
                if (task.status === 'upcoming') {
                     moveBtns = `<button onclick="moveTask(${task.id}, 'inprogress')" class="w-6 h-6 rounded-full bg-gray-100 dark:bg-white/10 hover:bg-ios-blue hover:text-white transition flex items-center justify-center text-[10px]" title="Move to In Progress"><i class="fa-solid fa-arrow-right"></i></button>`;
                } else if (task.status === 'inprogress') {
                     moveBtns = `
                        <button onclick="moveTask(${task.id}, 'upcoming')" class="w-6 h-6 rounded-full bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/20 transition flex items-center justify-center text-[10px]" title="Move Back"><i class="fa-solid fa-arrow-left"></i></button>
                        <button onclick="moveTask(${task.id}, 'done')" class="w-6 h-6 rounded-full bg-gray-100 dark:bg-white/10 hover:bg-ios-green hover:text-white transition flex items-center justify-center text-[10px]" title="Complete"><i class="fa-solid fa-check"></i></button>
                     `;
                } else if (task.status === 'done') {
                     moveBtns = `<button onclick="moveTask(${task.id}, 'inprogress')" class="w-6 h-6 rounded-full bg-gray-100 dark:bg-white/10 hover:bg-ios-orange hover:text-white transition flex items-center justify-center text-[10px]" title="Undo"><i class="fa-solid fa-rotate-left"></i></button>`;
                }

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2 pointer-events-none">
                        <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded-md ${badgeColor}">${task.priority}</span>
                        <div class="flex gap-2 pointer-events-auto">
                            <button class="text-gray-300 hover:text-blue-500 transition px-1 opacity-0 group-hover:opacity-100 md:opacity-0 md:group-hover:opacity-100 opacity-100" onclick="openTaskModal(${task.id})"><i class="fa-solid fa-pen"></i></button>
                            <button class="text-gray-300 hover:text-red-500 transition px-1 md:opacity-0 md:group-hover:opacity-100 opacity-100" onclick="deleteTask(${task.id})"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </div>
                    <div onclick="openViewTaskModal(${task.id})" class="cursor-pointer mb-2">
                        <h4 class="font-bold text-sm dark:text-white mb-1 pointer-events-none">${escapeHtml(task.title)}</h4>
                        <div class="text-xs text-gray-500 dark:text-gray-400 task-desc pointer-events-none max-h-20 overflow-hidden text-ellipsis">${formattedDesc}</div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-50 dark:border-white/5 pointer-events-auto">
                        <div class="flex items-center gap-2 text-[10px] text-gray-400 font-medium">
                            <i class="fa-regular fa-calendar"></i> ${dateStr}
                        </div>
                        <div class="flex gap-1.5">
                            ${moveBtns}
                        </div>
                    </div>
                `;
                
                if (cols[task.status]) cols[task.status].appendChild(div);
                if (task.status === 'done') completed++;
            });

            document.getElementById('countUpcoming').innerText = tasks.filter(t => t.status === 'upcoming').length;
            document.getElementById('countInProgress').innerText = tasks.filter(t => t.status === 'inprogress').length;
            document.getElementById('countDone').innerText = tasks.filter(t => t.status === 'done').length;

            const total = tasks.length;
            const pct = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('taskProgressBar').style.width = `${pct}%`;
            document.getElementById('taskProgressLabel').innerText = `${pct}%`;
            if (pct === 100 && total > 0) document.getElementById('taskProgressBar').classList.add('bg-ios-green');
            else document.getElementById('taskProgressBar').classList.remove('bg-ios-green');
        }

        function openViewTaskModal(id) {
            const task = appData.tasks.find(t => t.id === id);
            if (!task) return;
            
            document.getElementById('viewTaskTitle').innerText = task.title;
            const formattedDesc = formatTaskDescription(task.id, task.desc);
            document.getElementById('viewTaskDesc').innerHTML = formattedDesc;
            
            const pEl = document.getElementById('viewTaskPriority');
            pEl.innerText = task.priority;
            pEl.className = "text-[10px] font-bold uppercase px-2 py-0.5 rounded-md ";
            if(task.priority === 'high') pEl.className += "bg-red-100 text-red-500 dark:bg-red-500/20";
            else if(task.priority === 'medium') pEl.className += "bg-orange-100 text-orange-500 dark:bg-orange-500/20";
            else pEl.className += "bg-gray-100 text-gray-500 dark:bg-white/10 dark:text-gray-300";

            document.getElementById('viewTaskDate').innerHTML = `<i class="fa-regular fa-calendar mr-1"></i> ${task.date || 'No Date'}`;
            
            document.getElementById('viewTaskModal').classList.remove('hidden');
        }

        function closeViewTaskModal() {
            document.getElementById('viewTaskModal').classList.add('hidden');
        }

        // --- NEW UNIFIED DRAG LOGIC ---
        function startDrag(e, el, id) {
            // Ignore if touching interactive elements
            if (['INPUT', 'A', 'BUTTON', 'I', 'TEXTAREA'].includes(e.target.tagName)) return;
            
            const evt = e.type === 'touchstart' ? e.touches[0] : e;
            dragStartPos = { x: evt.clientX, y: evt.clientY };
            currentDragId = id;
            dragSourceEl = el;
            isDragging = false;

            if (e.type === 'mousedown') {
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('mouseup', onDragEnd);
            } else {
                document.addEventListener('touchmove', onDragMove, { passive: false });
                document.addEventListener('touchend', onDragEnd);
            }
        }

        function onDragMove(e) {
            const evt = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = evt.clientX - dragStartPos.x;
            const dy = evt.clientY - dragStartPos.y;

            if (!isDragging) {
                // Threshold check to distinguish click vs drag (5px)
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    isDragging = true;
                    createDragClone();
                    dragSourceEl.classList.add('dragging');
                }
            }

            if (isDragging) {
                if(e.cancelable) e.preventDefault(); // Prevent scrolling while dragging
                if (dragClone) {
                    const w = dragSourceEl.offsetWidth;
                    const h = dragSourceEl.offsetHeight;
                    dragClone.style.left = (evt.clientX - w/2) + 'px';
                    dragClone.style.top = (evt.clientY - h/2) + 'px';
                }
            }
        }

        function createDragClone() {
            if (dragClone) return;
            dragClone = dragSourceEl.cloneNode(true);
            dragClone.classList.add('drag-clone');
            dragClone.style.display = 'block'; // Ensure visible
            dragClone.style.width = dragSourceEl.offsetWidth + 'px';
            document.body.appendChild(dragClone);
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function onDragEnd(e) {
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            document.removeEventListener('touchmove', onDragMove);
            document.removeEventListener('touchend', onDragEnd);

            if (isDragging) {
                const evt = e.type === 'touchend' ? e.changedTouches[0] : e;
                if(dragClone) dragClone.style.display = 'none'; // Hide to find element below
                
                const targetEl = document.elementFromPoint(evt.clientX, evt.clientY);
                const col = targetEl ? targetEl.closest('[id^="col-"]') : null;
                
                if (col) {
                    const newStatus = col.id.replace('col-', '');
                    moveTask(currentDragId, newStatus);
                }
            }

            if (dragClone) dragClone.remove();
            if (dragSourceEl) dragSourceEl.classList.remove('dragging');
            
            dragClone = null;
            dragSourceEl = null;
            isDragging = false;
            currentDragId = null;
        }

        function moveTask(id, status) {
            const taskIndex = appData.tasks.findIndex(t => t.id === id);
            if (taskIndex > -1 && appData.tasks[taskIndex].status !== status) {
                appData.tasks[taskIndex].status = status;
                saveData();
                renderTasks();
                if(status === 'done') showToast("Task Completed!");
            }
        }

        function openTaskModal(id = null) {
            const modal = document.getElementById('addTaskModal');
            const titleEl = document.getElementById('taskModalTitle');
            const btnEl = document.getElementById('taskSaveBtn');
            const nameInput = document.getElementById('taskName');
            const dateInput = document.getElementById('taskDate');
            const prioInput = document.getElementById('taskPriority');
            const descInput = document.getElementById('taskDesc');

            if (id) {
                const task = appData.tasks.find(t => t.id === id);
                if (!task) return;
                editingTaskId = id;
                titleEl.innerText = "Edit Task";
                btnEl.innerText = "Update Task";
                nameInput.value = task.title;
                dateInput.value = task.date;
                prioInput.value = task.priority;
                descInput.value = task.desc;
            } else {
                editingTaskId = null;
                titleEl.innerText = "New Task";
                btnEl.innerText = "Create Task";
                nameInput.value = '';
                dateInput.valueAsDate = new Date();
                prioInput.value = 'low';
                descInput.value = '';
            }
            modal.classList.remove('hidden');
            if(window.innerWidth > 768) nameInput.focus();
        }
        
        function closeTaskModal() {
            document.getElementById('addTaskModal').classList.add('hidden');
        }

        function insertSubtask() {
            const desc = document.getElementById('taskDesc');
            desc.value += (desc.value.length > 0 && !desc.value.endsWith('\n') ? '\n' : '') + '- [ ] ';
            desc.focus();
        }

        function saveTask() {
            const title = document.getElementById('taskName').value.trim();
            const date = document.getElementById('taskDate').value;
            const priority = document.getElementById('taskPriority').value;
            const desc = document.getElementById('taskDesc').value.trim();

            if (!title) { showToast("Enter Task Name"); return; }
            
            if (editingTaskId) {
                // Update existing
                const index = appData.tasks.findIndex(t => t.id === editingTaskId);
                if (index > -1) {
                    appData.tasks[index].title = title;
                    appData.tasks[index].date = date;
                    appData.tasks[index].priority = priority;
                    appData.tasks[index].desc = desc;
                    showToast("Task Updated");
                }
            } else {
                // Create new
                const newTask = {
                    id: Date.now(),
                    title: title,
                    desc: desc,
                    date: date,
                    priority: priority,
                    status: 'upcoming'
                };
                if(!appData.tasks) appData.tasks = [];
                appData.tasks.unshift(newTask);
                showToast("Task Created");
            }
            
            saveData();
            renderTasks();
            closeTaskModal();
        }

        function deleteTask(id) {
            showConfirm("Delete this task?", () => {
                appData.tasks = appData.tasks.filter(t => t.id !== id);
                saveData();
                renderTasks();
            });
        }

        // --- EXPORT / IMPORT DATA ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "protracker_backup_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && typeof importedData === 'object') {
                        if (!importedData.currency) throw new Error("Invalid Format");
                        appData = { ...appData, ...importedData };
                        if(!Array.isArray(appData.subLimits)) appData.subLimits = [];
                        if(!Array.isArray(appData.transactions)) appData.transactions = [];
                        if(!Array.isArray(appData.subscriptions)) appData.subscriptions = [];
                        if(!Array.isArray(appData.tasks)) appData.tasks = [];
                        await saveData();
                        updateUI();
                        showToast("Data Imported Successfully");
                        closeSettingsModal();
                    }
                } catch(err) {
                    showToast("Import Failed: Invalid JSON");
                    console.error(err);
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function handleBankImport(input) {
            const file = input.files[0];
            if(!file) return;
            Papa.parse(file, {
                header: false, // Auto-detect or simple row scanning
                skipEmptyLines: true,
                complete: async function(results) {
                    let importedCount = 0;
                    results.data.forEach(row => {
                        let date = null;
                        let amount = null;
                        let desc = "Imported Transaction";
                        
                        row.forEach(cell => {
                            if(!cell) return;
                            const s = String(cell).trim();
                            // Check Date DD/MM/YYYY
                            if(!date && /^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)) {
                                const parts = s.split(/[\/\-\.]/);
                                if(parts.length === 3) date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                            }
                            // Check Amount
                            if(amount === null && /^[+-]?[\d,.]+$/.test(s) && s.length > 2) {
                                const clean = s.replace(/,/g,'').replace(/\./g,''); 
                                if(!isNaN(parseFloat(clean))) amount = parseFloat(clean); 
                            }
                            if(s.length > 10 && !/^\d/.test(s)) desc = s;
                        });

                        if (date && amount) {
                            const t = { 
                                id: Date.now() + Math.random(), 
                                date: date.toISOString(), 
                                desc: escapeHtml(desc), 
                                amount: Math.abs(amount), 
                                type: amount < 0 ? 'expense' : 'revenue', 
                                category: 'Uncategorized', 
                                account: 'bank' 
                            };
                            appData.transactions.unshift(t);
                            importedCount++;
                        }
                    });
                    
                    if(importedCount > 0) {
                        await saveData();
                        updateUI();
                        showToast(`Imported ${importedCount} transactions`);
                        closeSettingsModal();
                    } else {
                        showToast("No valid transactions found in CSV");
                    }
                }
            });
            input.value = '';
        }

        function showRegisterStep() {
            document.getElementById('authStep1').classList.add('hidden');
            document.getElementById('authStepRegister').classList.remove('hidden');
            document.getElementById('regUsernameInput').value = '';
            document.getElementById('regPinInput').value = '';
            document.getElementById('regStepPin').classList.add('hidden');
            document.getElementById('regStepUsername').classList.remove('hidden');
        }

        function resetAuth() {
            document.getElementById('authStep1').classList.remove('hidden');
            document.getElementById('authStepRegister').classList.add('hidden');
            document.getElementById('usernameInput').value = '';
            document.getElementById('loginPinInput').value = '';
            pendingUsername = '';
        }

        async function loginUser() {
            // FIX: Check if firebase module is loaded
            if (!window.fb) {
                showToast("System loading, please wait...");
                return;
            }

            const usernameInput = document.getElementById('usernameInput');
            const pinInput = document.getElementById('loginPinInput');
            const username = usernameInput.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const pin = pinInput.value;

            if (username.length < 3) { showToast("Invalid username"); return; }
            if (pin.length !== 4) { showToast("Enter 4-digit PIN"); return; }
            
            document.getElementById('authLoader').classList.remove('hidden');
            document.getElementById('loginBtn').disabled = true;
            document.getElementById('loginBtn').classList.add('opacity-50');
            usernameInput.disabled = true;
            pinInput.disabled = true;

            try {
                const userRef = getUserRef(username);
                // Safety check
                if (!userRef) { throw new Error("Initialization failed"); }

                const docSnap = await window.fb.getDoc(userRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.pin) {
                        // Check if hash exists, else check plaintext (legacy migration)
                        const inputHash = await sha256(pin);
                        // If stored pin is 64 chars, assume hash. Else plaintext
                        const isStoredHash = data.pin.length === 64;
                        
                        if ((isStoredHash && data.pin === inputHash) || (!isStoredHash && data.pin === pin)) {
                            // If legacy plaintext, migrate to hash immediately
                            if (!isStoredHash) {
                                appData = { ...data }; // ensure we have data to update
                                appData.pin = inputHash;
                                currentUserDocId = username; // need this for saveData
                                await saveData(); 
                            }
                            await completeLogin(username, false);
                        } else {
                            showToast("Incorrect PIN");
                            usernameInput.disabled = false;
                            pinInput.disabled = false;
                            pinInput.value = '';
                            pinInput.focus();
                        }
                    } else {
                        await completeLogin(username, true);
                    }
                } else {
                    showToast("User not found. Create an account?");
                    usernameInput.disabled = false;
                    pinInput.disabled = false;
                }
            } catch (e) {
                console.error(e);
                showToast("Login Error: " + (e.message || "Connection failed"));
                usernameInput.disabled = false;
                pinInput.disabled = false;
            } finally {
                document.getElementById('authLoader').classList.add('hidden');
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loginBtn').classList.remove('opacity-50');
            }
        }

        async function checkRegistrationUsername() {
            if (!window.fb) { showToast("System loading..."); return; }
            const input = document.getElementById('regUsernameInput');
            const username = input.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            if (username.length < 3) { showToast("Username too short"); return; }
            try {
                const userRef = getUserRef(username);
                const docSnap = await window.fb.getDoc(userRef);
                if (docSnap.exists()) {
                    showToast("Username taken");
                } else {
                    pendingUsername = username;
                    document.getElementById('regStepUsername').classList.add('hidden');
                    document.getElementById('regStepPin').classList.remove('hidden');
                    document.getElementById('regPinInput').focus();
                }
            } catch (e) { showToast("Error checking username"); }
        }

        async function completeRegistration() {
            if (!window.fb) return;
            const pin = document.getElementById('regPinInput').value;
            if (pin.length !== 4) { showToast("Enter 4 digits"); return; }
            const userRef = getUserRef(pendingUsername);
            
            document.getElementById('createAccBtn').disabled = true;
            document.getElementById('createAccBtn').classList.add('opacity-50');

            try {
                const pinHash = await sha256(pin);
                appData.pin = pinHash;
                appData.securityLogs = [{ timestamp: Date.now(), device: getDeviceModel() }];
                const cleanData = JSON.parse(JSON.stringify(appData));
                await window.fb.setDoc(userRef, cleanData);
                await completeLogin(pendingUsername, false);
            } catch (e) { 
                console.error(e); 
                showToast("Registration failed"); 
                document.getElementById('createAccBtn').disabled = false;
                document.getElementById('createAccBtn').classList.remove('opacity-50');
            }
        }

        async function completeLogin(username, isLegacyNoPin, skipUI = false) {
            currentUserDocId = username;
            localStorage.setItem('finTrack_username', username);
            try {
                const userRef = getUserRef(username);
                const deviceName = getDeviceModel();
                const snap = await window.fb.getDoc(userRef);
                if (snap.exists()) {
                    let logs = snap.data().securityLogs || [];
                    logs = logs.filter(l => l.device !== deviceName);
                    logs.push({ timestamp: Date.now(), device: deviceName });
                    // Use updateDoc for targeted update to avoid overwriting whole doc
                    await window.fb.updateDoc(userRef, { securityLogs: logs });
                }
            } catch(e) { console.error("Log update failed", e); }
            subscribeToData();
            if (!skipUI) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appUI').classList.remove('hidden');
                document.getElementById('appUI').classList.add('flex');
            }
            document.getElementById('settingsUsername').innerText = username;
            if (isLegacyNoPin) document.getElementById('legacyPinModal').classList.remove('hidden');
        }

        async function saveLegacyPin() {
            const pin = document.getElementById('legacyPinInput').value;
            if (pin.length !== 4) { showToast("Enter 4 digits"); return; }
            const pinHash = await sha256(pin);
            appData.pin = pinHash;
            await saveData();
            document.getElementById('legacyPinModal').classList.add('hidden');
            showToast("Account Secured!");
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            const img = document.getElementById('settingsAvatar');
            const navImg = document.getElementById('navbarAvatar');
            if (appData.avatar) { img.src = appData.avatar; navImg.src = appData.avatar; } 
            else { img.src = "https://img.icons8.com/fluency/96/user-male-circle.png"; }
            
            const logList = document.getElementById('securityLogsList');
            logList.innerHTML = '';
            if (appData.securityLogs && appData.securityLogs.length > 0) {
                const logs = [...appData.securityLogs].sort((a,b) => b.timestamp - a.timestamp).slice(0, 10);
                logs.forEach(log => {
                    const d = new Date(log.timestamp);
                    let deviceIcon = "fa-mobile-screen";
                    if(log.device.includes("Windows") || log.device.includes("Mac")) deviceIcon = "fa-desktop";
                    logList.innerHTML += `<div class="flex justify-between items-center text-xs p-2 border-b border-gray-100 dark:border-gray-700"><span class="text-gray-600 dark:text-gray-300 font-medium flex items-center gap-2"><i class="fa-solid ${deviceIcon} text-gray-400"></i> ${log.device}</span><span class="text-gray-400">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>`;
                });
            } else { logList.innerHTML = `<p class="text-xs text-gray-400 text-center">No logs available.</p>`; }

            const isDark = document.documentElement.classList.contains('dark');
            const toggle = document.getElementById('themeToggleIcon');
            toggle.className = isDark ? "fa-solid fa-toggle-on text-2xl text-ios-green" : "fa-solid fa-toggle-off text-2xl text-gray-300";
        }

        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); }

        function handleAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5000000) { showToast("Image too large (Max 5MB)"); return; }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const cropImage = document.getElementById('cropImage');
                    cropImage.src = e.target.result;
                    document.getElementById('cropModal').classList.remove('hidden');
                    document.getElementById('zoomRange').value = 1;
                    if (cropper) { cropper.destroy(); }
                    cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 0.8, guides: true, background: false, highlight: false, cropBoxMovable: false, cropBoxResizable: false, toggleDragModeOnDblclick: false });
                }
                reader.readAsDataURL(file);
            }
            input.value = '';
        }

        document.getElementById('zoomRange').addEventListener('input', function(e) { if(cropper) cropper.zoomTo(parseFloat(e.target.value)); });
        function rotateCropper(deg) { if(cropper) cropper.rotate(deg); }
        function resetCropper() { if(cropper) { cropper.reset(); document.getElementById('zoomRange').value = 1; } }

        function saveCroppedAvatar() {
            if (!cropper) return;
            // Reduce size to save bandwidth/storage
            const canvas = cropper.getCroppedCanvas({ width: 150, height: 150, imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
            const base64 = canvas.toDataURL('image/jpeg', 0.7); // 70% quality
            appData.avatar = base64;
            saveData();
            document.getElementById('settingsAvatar').src = base64;
            document.getElementById('navbarAvatar').src = base64;
            document.getElementById('navbarAvatar').classList.remove('hidden');
            document.getElementById('navbarIcon').classList.add('hidden');
            closeCropModal();
            showToast("Profile Picture Updated");
        }

        function closeCropModal() {
            document.getElementById('cropModal').classList.add('hidden');
            if(cropper) { cropper.destroy(); cropper = null; }
            document.getElementById('cropImage').src = "";
        }

        function removeAvatar() {
            appData.avatar = null;
            saveData();
            document.getElementById('settingsAvatar').src = "https://img.icons8.com/fluency/96/user-male-circle.png";
            document.getElementById('navbarAvatar').classList.add('hidden');
            document.getElementById('navbarIcon').classList.remove('hidden');
            showToast("Photo Removed");
        }

        function openChangePinModal() {
            document.getElementById('pinModalTitle').innerText = "Change PIN";
            document.getElementById('pinModalDesc').innerText = "Enter new 4-digit code";
            document.getElementById('genericPinInput').value = '';
            document.getElementById('pinModal').classList.remove('hidden');
            pinCallback = async (newPin) => {
                const pinHash = await sha256(newPin);
                appData.pin = pinHash;
                await saveData();
                showToast("PIN Changed Successfully");
                closePinModal();
            };
        }
        
        function submitGenericPin() {
            const val = document.getElementById('genericPinInput').value;
            if (val.length !== 4) { showToast("Must be 4 digits"); return; }
            if (pinCallback) pinCallback(val);
        }

        function closePinModal() {
            document.getElementById('pinModal').classList.add('hidden');
            pinCallback = null;
        }

        function subscribeToData() {
            if(!currentUserDocId || !window.fb) return;
            const userRef = getUserRef(currentUserDocId);
            unsubscribeSnapshot = window.fb.onSnapshot(userRef, (doc) => {
                if(doc.exists()) {
                    const newData = doc.data();
                    
                    if (!isInitialLoad && newData.notifications && newData.notifications.length > 0) {
                        const existingIds = new Set(appData.notifications.map(n => n.id));
                        newData.notifications.forEach(n => {
                            if (!existingIds.has(n.id) && !notifiedIds.has(n.id)) {
                                const notifTime = new Date(n.date).getTime();
                                if (Date.now() - notifTime < 60000) {
                                    if (Notification.permission === "granted") {
                                        new Notification("ProTracker Alert", { body: n.message, icon: "https://img.icons8.com/fluency/512/wallet.png" });
                                        notifiedIds.add(n.id);
                                    }
                                }
                            }
                        });
                    }
                    
                    appData = { ...appData, ...newData };
                    
                    // Ensure structure integrity
                    if (!appData.categories) appData.categories = ['Food', 'Transport', 'Shopping', 'Bill', 'Exchange'];
                    if (!Array.isArray(appData.subLimits)) appData.subLimits = [];
                    if (!Array.isArray(appData.transactions)) appData.transactions = [];
                    if (!Array.isArray(appData.subscriptions)) appData.subscriptions = [];
                    if (!Array.isArray(appData.notifications)) appData.notifications = [];
                    if (!Array.isArray(appData.tasks)) appData.tasks = [];
                    
                    if(appData.avatar) {
                          document.getElementById('navbarAvatar').src = appData.avatar;
                          document.getElementById('navbarAvatar').classList.remove('hidden');
                          document.getElementById('navbarIcon').classList.add('hidden');
                    } else {
                          document.getElementById('navbarAvatar').classList.add('hidden');
                          document.getElementById('navbarIcon').classList.remove('hidden');
                    }
                    
                    try { localStorage.setItem('finTrack_data', JSON.stringify(appData)); } catch(e) { console.warn("Cache full"); }

                    cleanupNotifications();
                    checkSubscriptionNotifications();
                    if(navigator.onLine) fetchLiveRate();
                    else if (appData.customRate) { exchangeRate = appData.customRate; isManualRate = true; updateRateDisplay(); }
                    
                    // Only update UI relevant to current mode
                    if(appMode === 'finance') updateUI();
                    else renderTasks();
                    
                    isInitialLoad = false;
                }
            });
        }

        async function saveData() { 
            if(currentUserDocId) {
                if (!navigator.onLine || !window.fb) {
                    offlineQueue.push(JSON.parse(JSON.stringify(appData))); 
                    localStorage.setItem('finTrack_offlineQueue', JSON.stringify(offlineQueue));
                    localStorage.setItem('finTrack_data', JSON.stringify(appData));
                    return;
                }
                const userRef = getUserRef(currentUserDocId);
                const cleanData = JSON.parse(JSON.stringify(appData));
                try { localStorage.setItem('finTrack_data', JSON.stringify(appData)); } catch(e){}
                await window.fb.setDoc(userRef, cleanData, { merge: true }); 
            }
        }
        
        async function processOfflineQueue() {
            if(offlineQueue.length > 0 && currentUserDocId && window.fb) {
                const userRef = getUserRef(currentUserDocId);
                const finalState = offlineQueue[offlineQueue.length-1];
                await window.fb.setDoc(userRef, finalState, { merge: true });
                offlineQueue = [];
                localStorage.removeItem('finTrack_offlineQueue');
                showToast("Offline changes synced");
            }
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) { showToast("Browser doesn't support notifications"); return; }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showToast("Notifications Enabled!");
                    new Notification("ProTracker", { body: "You will now receive subscription alerts.", icon: "https://img.icons8.com/fluency/512/wallet.png" });
                } else { showToast("Notifications Denied"); }
            });
        }

        function checkSubscriptionNotifications() {
             const now = new Date();
             let changed = false;
             appData.subscriptions.forEach(s => {
                if (!s.dueDate) return;
                const d = new Date(s.dueDate);
                let triggerDate = null;
                if (s.frequency === 'monthly') triggerDate = new Date(now.getFullYear(), now.getMonth(), d.getDate());
                else if (s.frequency === 'yearly') triggerDate = new Date(now.getFullYear(), d.getMonth(), d.getDate());
                if (triggerDate) {
                    const cycleId = s.frequency === 'monthly' ? `${s.id}_${now.getFullYear()}_${now.getMonth()}` : `${s.id}_${now.getFullYear()}`;
                    if (s.lastNotifiedCycle !== cycleId && triggerDate.getTime() <= now.getTime()) {
                        const notifId = Date.now() + Math.random();
                        const msg = `Subscription charged: ${s.name} (-${formatMoney(s.amount)})`;
                        appData.notifications.unshift({ id: notifId, title: "Subscription Charge", message: msg, date: new Date().toISOString(), read: false, type: 'subscription' });
                        
                        if (Notification.permission === "granted" && !isInitialLoad && !notifiedIds.has(notifId)) {
                             new Notification("ProTracker: Subscription Paid", { body: msg, icon: "https://img.icons8.com/fluency/512/wallet.png" });
                             notifiedIds.add(notifId);
                        }
                        s.lastNotifiedCycle = cycleId; 
                        changed = true;
                    }
                }
            });
            if(changed) saveData();
        }

        function cleanupNotifications() {
            const sixMonthsAgo = Date.now() - (1000 * 60 * 60 * 24 * 30 * 6);
            const originalLen = appData.notifications.length;
            appData.notifications = appData.notifications.filter(n => new Date(n.date).getTime() > sixMonthsAgo);
            if(appData.notifications.length !== originalLen) saveData();
        }

        function toggleNotifications(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('notifDropdown');
            const backdrop = document.getElementById('notifBackdrop');
            const badge = document.getElementById('notifBadge');
            const isClosed = dropdown.classList.contains('translate-y-full') || dropdown.classList.contains('md:opacity-0');
            if (isClosed) {
                dropdown.classList.remove('hidden'); 
                backdrop.classList.remove('hidden');
                requestAnimationFrame(() => {
                    dropdown.classList.remove('translate-y-full', 'md:opacity-0', 'md:scale-95', 'md:pointer-events-none');
                    backdrop.classList.remove('opacity-0', 'pointer-events-none');
                });
                renderNotificationsDropdown();
                badge.classList.add('hidden');
                if(appData.notifications) {
                    let changed = false;
                    appData.notifications.forEach(n => { if(!n.read) { n.read = true; changed = true; } });
                    if(changed) saveData();
                }
            } else {
                dropdown.classList.add('translate-y-full', 'md:opacity-0', 'md:scale-95', 'md:pointer-events-none');
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => { backdrop.classList.add('hidden'); }, 300);
            }
        }

        function renderNotificationsDropdown() {
            const list = document.getElementById('notifList');
            const empty = document.getElementById('notifEmpty');
            const countBadge = document.getElementById('notifCount');
            list.innerHTML = '';
            if (!appData.notifications || appData.notifications.length === 0) { 
                empty.classList.remove('hidden'); 
                if(countBadge) countBadge.classList.add('hidden');
                return; 
            }
            empty.classList.add('hidden');
            const sorted = [...appData.notifications].sort((a,b) => new Date(b.date) - new Date(a.date));
            const unreadCount = sorted.filter(n => !n.read).length;
            if(countBadge) {
                if(unreadCount > 0) {
                    countBadge.innerText = unreadCount > 9 ? '9+' : unreadCount;
                    countBadge.classList.remove('hidden');
                } else {
                    countBadge.classList.add('hidden');
                }
            }
            sorted.forEach(n => {
                const date = new Date(n.date);
                const isUnread = !n.read;
                list.innerHTML += `<div class="flex gap-3 p-3 rounded-xl transition-colors ${isUnread ? 'bg-blue-50 dark:bg-blue-900/20' : 'hover:bg-gray-50 dark:hover:bg-white/5'}"><div class="mt-1.5 w-2 h-2 rounded-full ${isUnread ? 'bg-ios-blue' : 'bg-transparent'} shrink-0"></div><div class="flex-grow"><div class="flex justify-between items-start"><p class="text-xs font-bold text-gray-900 dark:text-white">${n.title}</p><span class="text-[10px] text-gray-400 whitespace-nowrap ml-2">${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><p class="text-[11px] text-gray-600 dark:text-gray-300 leading-snug mt-0.5">${n.message}</p><p class="text-[9px] text-gray-400 mt-1">${date.toLocaleDateString()}</p></div></div>`;
            });
        }

        function clearAllNotifications() { appData.notifications = []; saveData(); renderNotificationsDropdown(); }

        const getMonthKey = (d) => `${d.getFullYear()}-${d.getMonth()}`;
        function formatCurrencyInput(i) { let v = i.value.replace(/\D/g, ""); i.value = v === "" ? "" : Number(v).toLocaleString('de-DE'); }
        function parseFormattedNumber(v) { return v ? parseFloat(v.replace(/\./g, '')) : 0; }
        function formatMoney(v) { return appData.currency === 'VND' ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(v) : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v / exchangeRate); }
        function showToast(m) { const el = document.getElementById('toast'); document.getElementById('toastMsg').innerText = m; el.classList.remove('opacity-0', 'translate-y-[-10px]'); setTimeout(() => el.classList.add('opacity-0', 'translate-y-[-10px]'), 2500); }
        function toggleTheme() { 
            document.documentElement.classList.toggle('dark'); 
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            const toggle = document.getElementById('themeToggleIcon');
            if(toggle) toggle.className = isDark ? "fa-solid fa-toggle-on text-2xl text-ios-green" : "fa-solid fa-toggle-off text-2xl text-gray-300";
            if (budgetChart) { budgetChart.destroy(); budgetChart = null; }
            if (bankChart) { bankChart.destroy(); bankChart = null; }
            if (cashChart) { cashChart.destroy(); cashChart = null; }
            updateUI(); 
        }
        function loadTheme() { if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        function changeMonth(d) { viewDate.setMonth(viewDate.getMonth() + d); updateUI(); }
        function jumpToToday() { viewDate = new Date(); updateUI(); showToast("Jumped to today"); }
        function toggleUserMenu(e) { e.stopPropagation(); }
        
        // --- GLOBAL WINDOW HANDLERS ---
        window.onclick = (e) => { 
            const nc = document.getElementById('notifContainer');
            if(nc && !nc.contains(e.target)) {
                const dropdown = document.getElementById('notifDropdown');
                const backdrop = document.getElementById('notifBackdrop');
                const isVisiblyOpen = !dropdown.classList.contains('translate-y-full') && !dropdown.classList.contains('md:opacity-0');
                if (isVisiblyOpen) {
                    dropdown.classList.add('translate-y-full', 'md:opacity-0', 'md:scale-95', 'md:pointer-events-none');
                    backdrop.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => { backdrop.classList.add('hidden'); }, 300);
                }
            }
            const sm = document.getElementById('settingsModal'); if(sm && !sm.classList.contains('hidden') && e.target===sm) closeSettingsModal();
            const pm = document.getElementById('pinModal'); if(pm && !pm.classList.contains('hidden') && e.target===pm) closePinModal();
            const slm = document.getElementById('subLimitModal'); if (slm && !slm.classList.contains('hidden') && e.target === slm) closeSubLimitModal();
            const subm = document.getElementById('subscriptionModal'); if (subm && !subm.classList.contains('hidden') && e.target === subm) closeSubscriptionModal();
            const catm = document.getElementById('categoryModal'); if (catm && !catm.classList.contains('hidden') && e.target === catm) closeCategoryModal();
            const cm = document.getElementById('confirmModal'); if (cm && !cm.classList.contains('hidden') && e.target === cm) closeConfirm(false);
            const cpm = document.getElementById('cropModal'); if (cpm && !cpm.classList.contains('hidden') && e.target === cpm) closeCropModal();
            const tam = document.getElementById('addTaskModal'); if (tam && !tam.classList.contains('hidden') && e.target === tam) closeTaskModal();
            const vtm = document.getElementById('viewTaskModal'); if (vtm && !vtm.classList.contains('hidden') && e.target === vtm) closeViewTaskModal();
        };

        window.openSubLimitModal = function(id = null) {
            if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; }
            const modal = document.getElementById('subLimitModal');
            const title = document.getElementById('subLimitModalTitle');
            const saveBtn = document.getElementById('subLimitSaveBtn');
            const deleteBtn = document.getElementById('subLimitDeleteBtn');
            const nameIn = document.getElementById('subLimitNameInput');
            const amtIn = document.getElementById('subLimitAmountInput');
            document.getElementById('subLimitCurrencySymbol').innerText = appData.currency === 'VND' ? 'â‚«' : '$';

            if (id) {
                const sl = appData.subLimits.find(s => s.id === id);
                if (!sl) return;
                editingSubLimitId = id;
                title.innerText = "Edit Sub-Limit";
                saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> <span>Update Budget</span>';
                deleteBtn.classList.remove('hidden');
                nameIn.value = sl.name;
                let val = sl.limit;
                if (appData.currency === 'USD') val = val / exchangeRate;
                amtIn.value = Number(Math.round(val)).toLocaleString('de-DE');
            } else {
                editingSubLimitId = null;
                title.innerText = "New Sub-Limit";
                saveBtn.innerHTML = '<i class="fa-solid fa-plus"></i> <span>Create Budget</span>';
                deleteBtn.classList.add('hidden');
                nameIn.value = '';
                amtIn.value = '';
            }
            modal.classList.remove('hidden');
            nameIn.focus();
        };

        window.closeSubLimitModal = function() { document.getElementById('subLimitModal').classList.add('hidden'); };

        window.saveSubLimit = function() {
            if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; }
            const name = document.getElementById('subLimitNameInput').value.trim();
            const limitVal = parseFormattedNumber(document.getElementById('subLimitAmountInput').value);
            if (name && limitVal > 0) {
                const storeLimit = appData.currency === 'USD' ? limitVal * exchangeRate : limitVal;
                
                if(!Array.isArray(appData.subLimits)) appData.subLimits = [];

                if (editingSubLimitId) { const index = appData.subLimits.findIndex(s => s.id === editingSubLimitId); if (index !== -1) { appData.subLimits[index].name = name; appData.subLimits[index].limit = storeLimit; showToast("Sub-limit updated"); } } 
                else { appData.subLimits.push({ id: Date.now(), name: name, limit: storeLimit }); showToast("Sub-limit created"); }
                window.closeSubLimitModal(); saveData(); updateUI();
            }
        };

        window.deleteSubLimit = function(id) { if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; } showConfirm("Delete budget?", () => { appData.subLimits = appData.subLimits.filter(s => s.id !== id); saveData(); }); };
        window.deleteSubLimitFromModal = function() { if (editingSubLimitId) { window.deleteSubLimit(editingSubLimitId); window.closeSubLimitModal(); } };
        
        window.openSubscriptionModal = function(id = null) {
            if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; }
            const modal = document.getElementById('subscriptionModal');
            const title = document.getElementById('subModalTitle');
            const saveBtn = document.getElementById('subSaveBtn');
            const deleteBtn = document.getElementById('subDeleteBtn');
            const nameIn = document.getElementById('modalSubName');
            const amtIn = document.getElementById('modalSubAmount');
            const freqIn = document.getElementById('modalSubFreq');
            const dateIn = document.getElementById('modalSubDate');
            document.getElementById('modalSubCurrency').innerText = appData.currency === 'VND' ? 'â‚«' : '$';
            if (id) {
                const s = appData.subscriptions.find(sub => sub.id === id); if (!s) return;
                editingSubId = id; title.innerText = "Edit Subscription"; saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> <span>Update Subscription</span>'; deleteBtn.classList.remove('hidden');
                nameIn.value = s.name; let val = s.amount; if (appData.currency === 'USD') val = val / exchangeRate; amtIn.value = Number(Math.round(val)).toLocaleString('de-DE'); freqIn.value = s.frequency || 'monthly';
                if (s.dueDate) dateIn.value = s.dueDate.split('T')[0]; else { const now = new Date(); const m = s.dueMonth !== undefined ? s.dueMonth : now.getMonth(); dateIn.value = new Date(now.getFullYear(), m, 1).toISOString().split('T')[0]; }
            } else { editingSubId = null; title.innerText = "New Subscription"; saveBtn.innerHTML = '<i class="fa-solid fa-plus"></i> <span>Add Subscription</span>'; deleteBtn.classList.add('hidden'); nameIn.value = ''; amtIn.value = ''; freqIn.value = 'monthly'; dateIn.value = new Date().toISOString().split('T')[0]; }
            modal.classList.remove('hidden'); nameIn.focus();
        };
        window.closeSubscriptionModal = function() { document.getElementById('subscriptionModal').classList.add('hidden'); };
        window.deleteSubscriptionFromModal = function() { if(editingSubId) { window.deleteSubscription(editingSubId); window.closeSubscriptionModal(); } };
        window.saveSubscription = function() {
            if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; }
            const name = document.getElementById('modalSubName').value.trim(); const val = parseFormattedNumber(document.getElementById('modalSubAmount').value); const freq = document.getElementById('modalSubFreq').value; const dateStr = document.getElementById('modalSubDate').value;
            if (name && val > 0 && dateStr) {
                const amount = appData.currency === 'USD' ? val * exchangeRate : val; const d = new Date(dateStr);
                const subData = { name, amount, frequency: freq, dueDate: d.toISOString(), dueMonth: d.getMonth() };
                if (editingSubId) { const idx = appData.subscriptions.findIndex(s => s.id === editingSubId); if (idx !== -1) { appData.subscriptions[idx] = { ...appData.subscriptions[idx], ...subData }; showToast("Subscription updated"); } } 
                else { appData.subscriptions.push({ id: Date.now(), ...subData }); showToast("Subscription added"); }
                window.closeSubscriptionModal(); saveData(); updateUI();
            } else { showToast("Please fill all fields"); }
        };
        window.deleteSubscription = function(id) { if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; } showConfirm("Delete sub?", () => { appData.subscriptions = appData.subscriptions.filter(s => s.id !== id); saveData(); }); };
        
        window.addTransaction = addTransaction;
        window.deleteTransaction = deleteTransaction;
        window.setTransactionAccount = setTransactionAccount;
        window.openCategoryModal = openCategoryModal;
        window.closeCategoryModal = closeCategoryModal;
        window.deleteCategory = deleteCategory;
        
        window.handleLogout = handleLogout;
        window.handleDeleteAccount = handleDeleteAccount;
        window.toggleTheme = toggleTheme;
        window.openChangePinModal = openChangePinModal;
        window.exportData = exportData;
        window.importData = importData;
        window.handleBankImport = handleBankImport;
        window.requestNotificationPermission = requestNotificationPermission;
        window.toggleNotifications = toggleNotifications;
        window.clearAllNotifications = clearAllNotifications;
        window.toggleCurrency = toggleCurrency;
        window.openSettingsModal = openSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.changeMonth = changeMonth;
        window.jumpToToday = jumpToToday;
        window.toggleStatsView = toggleStatsView;
        window.handleSearch = handleSearch;
        window.updateSort = updateSort;
        window.setMonthLimit = setMonthLimit;
        window.editExchangeRate = editExchangeRate;
        window.loginUser = loginUser;
        window.showRegisterStep = showRegisterStep;
        window.checkRegistrationUsername = checkRegistrationUsername;
        window.resetAuth = resetAuth;
        window.completeRegistration = completeRegistration;
        window.closePinModal = closePinModal;
        window.submitGenericPin = submitGenericPin;
        window.saveLegacyPin = saveLegacyPin;
        window.removeAvatar = removeAvatar;
        window.handleAvatarUpload = handleAvatarUpload;
        window.closeCropModal = closeCropModal;
        window.saveCroppedAvatar = saveCroppedAvatar;
        window.rotateCropper = rotateCropper;
        window.resetCropper = resetCropper;
        window.closeConfirm = closeConfirm;
        
        // Task Export functions
        window.toggleAppMode = toggleAppMode;
        window.openTaskModal = openTaskModal;
        window.closeTaskModal = closeTaskModal;
        window.saveTask = saveTask;
        window.deleteTask = deleteTask;
        window.startDrag = startDrag;
        window.onDragMove = onDragMove;
        window.onDragEnd = onDragEnd;
        window.toggleSubtask = toggleSubtask;
        window.openViewTaskModal = openViewTaskModal;
        window.closeViewTaskModal = closeViewTaskModal;
        window.insertSubtask = insertSubtask;
        window.moveTask = moveTask;

        function handleSearch(val) { searchQuery = val.toLowerCase(); updateUI(); }
        function toggleStatsView() { setStatsView(statsViewMode === 'monthly' ? 'all' : 'monthly'); }
        function setStatsView(mode) { statsViewMode = mode; updateUI(); }
        function openCategoryModal() {
            if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; }
            const list = document.getElementById('categoryListContainer');
            list.innerHTML = '';
            appData.categories.sort().forEach(cat => {
                list.innerHTML += `<div class="flex justify-between items-center bg-gray-100 dark:bg-white/5 p-3 rounded-xl group"><span class="text-sm font-bold dark:text-gray-200">${escapeHtml(cat)}</span><button onclick="deleteCategory('${escapeHtml(cat)}')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div>`;
            });
            document.getElementById('categoryModal').classList.remove('hidden');
        }
        function closeCategoryModal() { document.getElementById('categoryModal').classList.add('hidden'); }
        function deleteCategory(cat) { 
            showConfirm(`Delete category "${cat}"?`, () => { 
                appData.categories = appData.categories.filter(c => c !== cat); 
                appData.transactions.forEach(t => { if(t.category === cat) t.category = 'Uncategorized'; });
                saveData(); 
                openCategoryModal(); 
                updateUI(); 
            }); 
        }
        function setTransactionAccount(acct) {
            selectedTransAccount = acct;
            const btnBank = document.getElementById('btnAcctBank');
            const btnCash = document.getElementById('btnAcctCash');
            const activeClass = ['bg-white', 'dark:bg-gray-700', 'text-black', 'dark:text-white', 'shadow-sm'];
            const inactiveClass = ['text-gray-500', 'dark:text-gray-400'];
            if(acct === 'bank') { btnBank.classList.add(...activeClass); btnBank.classList.remove(...inactiveClass); btnCash.classList.remove(...activeClass); btnCash.classList.add(...inactiveClass); } 
            else { btnCash.classList.add(...activeClass); btnCash.classList.remove(...inactiveClass); btnBank.classList.remove(...activeClass); btnBank.classList.add(...inactiveClass); }
        }
        function addTransaction(type) {
            if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; }
            const descInput = document.getElementById('descInput');
            const amtInput = document.getElementById('amountInput');
            const catInput = document.getElementById('categoryInput');
            const isTransfer = type === 'transfer';
            const val = parseFormattedNumber(amtInput.value);
            let cat = isTransfer ? 'Exchange' : (catInput.value.trim() || 'Uncategorized');
            const desc = descInput.value.trim() || (isTransfer ? 'Transfer' : (type === 'expense' ? 'Expense' : 'Income'));
            const source = document.getElementById('budgetSelect').value;
            if (val > 0) {
                const btnId = type === 'expense' ? 'btnExpense' : (type === 'transfer' ? 'btnTransfer' : 'btnRevenue');
                const btn = document.getElementById(btnId);
                if(btn) btn.classList.add('opacity-50', 'pointer-events-none');

                const amount = appData.currency === 'USD' ? val * exchangeRate : val;
                const date = new Date().toISOString();
                const ts = Date.now();
                if (isTransfer) {
                    const otherAccount = selectedTransAccount === 'bank' ? 'cash' : 'bank';
                    const transferDesc = desc === 'Transfer' ? `Transfer to ${otherAccount}` : desc;
                    const t1 = { id: ts, date: date, desc: escapeHtml(transferDesc), amount: amount, type: 'expense', category: 'Exchange', account: selectedTransAccount };
                    const t2 = { id: ts + 1, date: date, desc: `Received from ${selectedTransAccount}`, amount: amount, type: 'revenue', category: 'Exchange', account: otherAccount };
                    appData.transactions.unshift(t1); appData.transactions.unshift(t2);
                    showToast(`Transferred: ${selectedTransAccount} âž ${otherAccount}`);
                } else {
                    const t = { id: ts, date: date, desc: escapeHtml(desc), amount: amount, type, category: escapeHtml(cat), account: selectedTransAccount };
                    if(type === 'expense' && source !== 'general') t.subLimitId = parseInt(source);
                    if (cat && !appData.categories.includes(cat) && cat !== 'Exchange') appData.categories.push(cat);
                    appData.transactions.unshift(t);
                    showToast("Transaction added");
                }
                descInput.value = ''; amtInput.value = ''; catInput.value = ''; 
                saveData().finally(() => {
                    if(btn) btn.classList.remove('opacity-50', 'pointer-events-none');
                });
            }
        }
        function deleteTransaction(id) { if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; } showConfirm("Delete?", () => { appData.transactions = appData.transactions.filter(t => t.id !== id); saveData(); showToast("Deleted"); }); }
        function setMonthLimit() { if (!isCurrentViewMonth()) { showToast("Cannot edit past data"); return; } const v = parseFormattedNumber(document.getElementById('limitInput').value); if(v>=0) { appData.limits[getMonthKey(viewDate)] = appData.currency === 'USD' ? v * exchangeRate : v; document.getElementById('limitInput').value = ''; saveData(); showToast("Limit set"); } }

        function showConfirm(m, cb) { document.getElementById('confirmMessage').innerText = m; confirmCallback = cb; document.getElementById('confirmModal').classList.remove('hidden'); }
        function closeConfirm(y) { document.getElementById('confirmModal').classList.add('hidden'); if(y && confirmCallback) confirmCallback(); }
        document.getElementById('confirmYesBtn').onclick = () => closeConfirm(true);
        function updateSort(v) { currentSort = v; updateUI(); }
        
        function handleLogout() {
             if(unsubscribeSnapshot) unsubscribeSnapshot();
             
             appData = {};
             localStorage.removeItem('finTrack_username'); 
             localStorage.removeItem('finTrack_data'); 
             if(auth) window.fb.signOut(auth);
             location.reload(); 
        }

        function handleDeleteAccount() { 
            showConfirm("PERMANENTLY DELETE?", async () => { 
                if(currentUserDocId) { 
                    try {
                        const userRef = getUserRef(currentUserDocId);
                        await window.fb.deleteDoc(userRef); 
                        showToast("Account Deleted");
                        setTimeout(handleLogout, 1000);
                    } catch(e) {
                        console.error(e);
                        showToast("Delete Failed: " + e.code);
                    }
                } else {
                    handleLogout();
                }
            }); 
        }
        
        async function fetchLiveRate() { 
            if(!navigator.onLine) {
                const rateEl = document.getElementById('rateDisplay'); rateEl.classList.add('text-amber-500'); rateEl.classList.remove('text-ios-blue');
                const mob = document.getElementById('rateDisplayMobile'); if(mob) { mob.classList.add('text-amber-500'); mob.classList.remove('text-ios-blue'); }
                return;
            }
            try { const r=await fetch('https://open.er-api.com/v6/latest/USD'); const d=await r.json(); exchangeRate = d.rates.VND; isManualRate = false; appData.customRate = null; updateRateDisplay(); if(appMode === 'finance') updateUI(); } catch(e) { console.warn("Rate fetch failed"); } 
        }
        function editExchangeRate() { const r=prompt("Custom Rate (USD->VND):", parseInt(exchangeRate)); if(r){ exchangeRate=parseFloat(r); isManualRate=true; appData.customRate=exchangeRate; saveData(); showToast("Manual Rate Set"); updateRateDisplay(); updateUI(); } }
        function updateRateDisplay() { 
            const text = `1$ â‰ˆ ${new Intl.NumberFormat().format(parseInt(exchangeRate))}â‚«`;
            const el = document.getElementById('rateDisplay'); if(el) el.innerText = text; 
            const mob = document.getElementById('rateDisplayMobile'); if(mob) mob.innerText = text;
            if(isManualRate || !navigator.onLine) { if(el) { el.classList.add('text-amber-500'); el.classList.remove('text-ios-blue'); } if(mob) { mob.classList.add('text-amber-500'); mob.classList.remove('text-ios-blue'); } } 
            else { if(el) { el.classList.remove('text-amber-500'); el.classList.add('text-ios-blue'); } if(mob) { mob.classList.remove('text-amber-500'); mob.classList.add('text-ios-blue'); } }
        }
        function toggleCurrency() { appData.currency = appData.currency === 'USD' ? 'VND' : 'USD'; updateUI(); saveData(); }

        function updateUI() {
            const isMonthly = statsViewMode === 'monthly';
            const badge = document.getElementById('viewModeBadge'); badge.innerText = isMonthly ? 'Mo' : 'All';
            const notifBadge = document.getElementById('notifBadge'); if(appData.notifications && appData.notifications.some(n => !n.read)) notifBadge.classList.remove('hidden'); else notifBadge.classList.add('hidden');
            document.getElementById('currencyLabel').innerText = appData.currency; document.getElementById('inputCurrencySymbol').innerText = appData.currency === 'VND' ? 'â‚«' : '$'; document.getElementById('currentMonthDisplay').innerText = viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const sel = document.getElementById('budgetSelect'); const oldVal = sel.value; sel.innerHTML = `<option value="general">General (Monthly Limit)</option>`; appData.subLimits.forEach(sl => { const o = document.createElement('option'); o.value = sl.id; o.text = sl.name; sel.appendChild(o); }); sel.value = oldVal;
            const dl = document.getElementById('categoryList'); dl.innerHTML = ''; appData.categories.sort().forEach(c => { const o = document.createElement('option'); o.value = c; dl.appendChild(o); });
            
            let allInc = 0, allExp = 0, bankRealInc = 0, bankRealExp = 0, bankTransIn = 0, bankTransOut = 0, cashRealInc = 0, cashRealExp = 0, cashTransIn = 0, cashTransOut = 0;
            appData.transactions.forEach(t => { 
                const acct = t.account || 'bank'; const isExchange = (t.category || '').toLowerCase() === 'exchange';
                if (t.type==='revenue') { if (acct === 'bank') { if (isExchange) bankTransIn += t.amount; else bankRealInc += t.amount; } else { if (isExchange) cashTransIn += t.amount; else cashRealInc += t.amount; } if(!isExchange) allInc += t.amount; } 
                else { if (acct === 'bank') { if (isExchange) bankTransOut += t.amount; else bankRealExp += t.amount; } else { if (isExchange) cashTransOut += t.amount; else cashRealExp += t.amount; } if(!isExchange) allExp += t.amount; }
            });
            let subCostAllTime = 0; const now = new Date(); appData.subscriptions.forEach(s => { let m = 0; while(m <= now.getMonth()) { const isCurrentMonth = m === now.getMonth(); let dueDay = 1; if (s.dueDate) dueDay = new Date(s.dueDate).getDate(); let shouldCharge = false; if (s.frequency === 'monthly') { if (!isCurrentMonth) shouldCharge = true; else if (now.getDate() >= dueDay) shouldCharge = true; } else if (s.frequency === 'yearly') { const dueM = s.dueDate ? new Date(s.dueDate).getMonth() : s.dueMonth; if (dueM === m) { if (!isCurrentMonth) shouldCharge = true; else if (now.getDate() >= dueDay) shouldCharge = true; } } if (shouldCharge) subCostAllTime += s.amount; m++; } });
            bankRealExp += subCostAllTime; allExp += subCostAllTime;
            const bankBalance = (bankRealInc + bankTransIn) - (bankRealExp + bankTransOut); const cashBalance = (cashRealInc + cashTransIn) - (cashRealExp + cashTransOut); const totalWallet = bankBalance + cashBalance;
            let displayInc = 0, displayExp = 0;
            if (isMonthly) {
                const mTrans = appData.transactions.filter(t => new Date(t.date).getMonth() === viewDate.getMonth() && new Date(t.date).getFullYear() === viewDate.getFullYear());
                mTrans.forEach(t => { const isExchange = (t.category || '').toLowerCase() === 'exchange'; if(!isExchange) { if(t.type==='revenue') displayInc+=t.amount; else displayExp+=t.amount; } });
                appData.subscriptions.forEach(s => { const dueM = s.dueDate ? new Date(s.dueDate).getMonth() : s.dueMonth; if(s.frequency === 'monthly' || (s.frequency === 'yearly' && dueM === viewDate.getMonth())) displayExp += s.amount; });
            } else { displayInc = allInc; displayExp = allExp; }
            document.getElementById('incomeDisplay').innerText = formatMoney(displayInc); document.getElementById('spentDisplay').innerText = formatMoney(displayExp); document.getElementById('walletDisplay').innerText = formatMoney(totalWallet);
            
            const mTransCurrent = appData.transactions.filter(t => new Date(t.date).getMonth() === viewDate.getMonth() && new Date(t.date).getFullYear() === viewDate.getFullYear());
            let genSpent = 0, subSpent = {}; mTransCurrent.forEach(t => { const isExchange = (t.category || '').toLowerCase() === 'exchange'; if(t.type==='expense' && !isExchange) { if(t.subLimitId) subSpent[t.subLimitId] = (subSpent[t.subLimitId]||0)+t.amount; else genSpent += t.amount; } });
            const mSubs = appData.subscriptions.reduce((s, sub) => { const dueM = sub.dueDate ? new Date(sub.dueDate).getMonth() : sub.dueMonth; const isDueMonth = (sub.frequency==='monthly' || (sub.frequency==='yearly' && dueM === viewDate.getMonth())); return isDueMonth ? s+sub.amount : s; }, 0);
            const limit = appData.limits[getMonthKey(viewDate)] || 0; const mainRem = Math.max(0, limit - (genSpent + mSubs)); document.getElementById('monthlyLeftDisplay').innerText = formatMoney(mainRem);
            
            const isDark = document.documentElement.classList.contains('dark'); const bg = isDark ? '#2C2C2E' : '#E5E7EB';
            const p = limit > 0 ? mainRem / limit : 0; const col = p < 0.2 ? '#FF3B30' : (p < 0.5 ? '#FF9500' : '#007AFF');
            document.getElementById('centerBudgetRemaining').innerText = formatMoney(mainRem); document.getElementById('centerLimitLabel').innerText = "Limit: " + formatMoney(limit);
            
            if(budgetChart) budgetChart.destroy();
            budgetChart = new Chart(document.getElementById('budgetWheel'), { type: 'doughnut', options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: {display:false}, tooltip: {enabled:false} }, animation: { duration: 600 } }, data: { datasets: [{ data: limit === 0 ? [0, 100] : [mainRem, limit - mainRem], backgroundColor: limit === 0 ? [bg, bg] : [col, bg], borderWidth: 0 }] } });
            
            const bankNetTransfer = bankTransIn - bankTransOut; let bankChartData = []; if (bankNetTransfer >= 0) bankChartData = [bankBalance, bankRealExp]; else bankChartData = [bankBalance, bankRealExp + Math.abs(bankNetTransfer)];
            const cashNetTransfer = cashTransIn - cashTransOut; let cashChartData = []; if (cashNetTransfer >= 0) cashChartData = [cashBalance, cashRealExp]; else cashChartData = [cashBalance, cashRealExp + Math.abs(cashNetTransfer)];
            if (bankChartData[0] <= 0) bankChartData = [0, 100]; if (cashChartData[0] <= 0) cashChartData = [0, 100];
            document.getElementById('centerBankBalance').innerText = formatMoney(bankBalance); document.getElementById('centerCashBalance').innerText = formatMoney(cashBalance); document.getElementById('footerTotalIncome').innerText = formatMoney(allInc); document.getElementById('footerTotalSpent').innerText = formatMoney(allExp);
            
            if(bankChart) bankChart.destroy();
            bankChart = new Chart(document.getElementById('bankWheel'), { type: 'doughnut', options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: {display:false}, tooltip: {enabled:false} }, animation: { duration: 600 } }, data: { datasets: [{ data: bankChartData, backgroundColor: bankBalance <= 0 ? [bg, bg] : ['#007AFF', '#FF3B30'], borderWidth: 0 }] } });
            
            if(cashChart) cashChart.destroy();
            cashChart = new Chart(document.getElementById('cashWheel'), { type: 'doughnut', options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: {display:false}, tooltip: {enabled:false} }, animation: { duration: 600 } }, data: { datasets: [{ data: cashChartData, backgroundColor: cashBalance <= 0 ? [bg, bg] : ['#34C759', '#FF3B30'], borderWidth: 0 }] } });

            const isCurrent = isCurrentViewMonth(); const lockMsg = document.getElementById('lockedMessage'); const inputs = ['limitControl', 'transControl']; const addSubBtn = document.getElementById('addSubBtn');
            if (isCurrent) { lockMsg.classList.add('hidden'); inputs.forEach(id => document.getElementById(id).classList.remove('disabled-overlay')); addSubBtn.classList.remove('pointer-events-none', 'opacity-50'); } 
            else { lockMsg.classList.remove('hidden'); inputs.forEach(id => document.getElementById(id).classList.add('disabled-overlay')); addSubBtn.classList.add('pointer-events-none', 'opacity-50'); }

            renderSubs(); renderSubLimits(subSpent); renderHistory(mTransCurrent); renderComparison();
        }

        function renderSubLimits(spentMap) {
            const c = document.getElementById('subLimitsContainer'); c.innerHTML = '';
            if(appData.subLimits.length===0) document.getElementById('emptySubLimits').classList.remove('hidden'); else document.getElementById('emptySubLimits').classList.add('hidden');
            appData.subLimits.forEach(sl => {
                const s = spentMap[sl.id] || 0; const rem = Math.max(0, sl.limit - s); const pct = Math.min(100, (rem/sl.limit)*100);
                const col = rem > 0 ? 'bg-ios-purple' : 'bg-ios-red'; const txt = rem > 0 ? 'text-ios-purple' : 'text-ios-red';
                const delBtn = isCurrentViewMonth() ? `<button onclick="window.deleteSubLimit(${sl.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-xmark"></i></button>` : '';
                const editBtn = isCurrentViewMonth() ? `<button onclick="window.openSubLimitModal(${sl.id})" class="absolute top-2 right-8 text-gray-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-pen"></i></button>` : '';
                c.innerHTML += `<div class="bg-white/50 dark:bg-white/5 p-4 rounded-2xl flex flex-col justify-between relative group border border-gray-100 dark:border-gray-800 hover-lift gpu-accel">${editBtn}${delBtn}<div class="mb-2"><h3 class="text-sm font-bold truncate dark:text-white">${escapeHtml(sl.name)}</h3><p class="text-[10px] text-gray-400">Limit: ${formatMoney(sl.limit)}</p></div><div class="w-full"><div class="flex justify-between items-end mb-1"><span class="text-[10px] font-semibold text-gray-500">Left</span><span class="text-xs font-bold ${txt}">${formatMoney(rem)}</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden"><div class="h-full rounded-full transition-all duration-500 ${col}" style="width: ${pct}%"></div></div></div></div>`;
            });
        }
        
        function renderSubs() {
             const l = document.getElementById('subscriptionList'); l.innerHTML = '';
             if(appData.subscriptions.length===0) document.getElementById('emptySubs').classList.remove('hidden'); else document.getElementById('emptySubs').classList.add('hidden');
             appData.subscriptions.forEach(s => {
                let dateDisplay = ''; if (s.dueDate) { const d = new Date(s.dueDate); const day = d.getDate(); if(s.frequency === 'yearly') dateDisplay = `${monthNames[d.getMonth()]} ${day}`; else dateDisplay = `Day ${day}`; } else { dateDisplay = s.frequency === 'yearly' ? monthNames[s.dueMonth] : 'Monthly'; }
                const tag = s.frequency === 'yearly' ? `<span class="text-[9px] bg-orange-100 text-orange-600 px-1.5 rounded font-bold">YR</span>` : `<span class="text-[9px] bg-purple-100 text-purple-600 px-1.5 rounded font-bold">MO</span>`;
                const editBtn = isCurrentViewMonth() ? `<button onclick="window.openSubscriptionModal(${s.id})" class="text-gray-300 hover:text-blue-500 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-pen"></i></button>` : '';
                l.innerHTML += `<div class="flex justify-between items-center bg-white/50 dark:bg-white/5 p-3 rounded-xl mb-2 group"><div class="flex items-center gap-2 overflow-hidden">${tag}<div class="flex flex-col"><span class="text-sm font-medium dark:text-gray-200 truncate">${escapeHtml(s.name)}</span><span class="text-[10px] text-gray-400 font-medium">Due: ${dateDisplay}</span></div></div><div class="flex items-center gap-3 shrink-0"><span class="text-sm font-bold text-gray-700 dark:text-gray-300">-${formatMoney(s.amount)}</span>${editBtn}</div></div>`;
             });
        }
        function renderHistory(t) {
            const l = document.getElementById('historyList'); l.innerHTML = '';
            if(t.length===0) { l.innerHTML = `<li class="text-center text-gray-400 text-sm py-4">No activity.</li>`; return; }
            let sorted = [...t];
            if (searchQuery) { sorted = sorted.filter(item => { const descMatch = (item.desc || '').toLowerCase().includes(searchQuery); const catMatch = (item.category || '').toLowerCase().includes(searchQuery); let subLimitMatch = false; if(item.subLimitId) { const sl = appData.subLimits.find(s => s.id === item.subLimitId); if(sl && sl.name.toLowerCase().includes(searchQuery)) subLimitMatch = true; } return descMatch || catMatch || subLimitMatch; }); if(sorted.length === 0) { l.innerHTML = `<li class="text-center text-gray-400 text-sm py-4">No matches found.</li>`; return; } }
            if(currentSort === 'newest') sorted.sort((a,b)=>new Date(b.date)-new Date(a.date)); else if(currentSort === 'oldest') sorted.sort((a,b)=>new Date(a.date)-new Date(b.date)); else if(currentSort === 'high') sorted.sort((a,b)=>b.amount-a.amount);
            sorted.forEach(x => {
                const isExchange = (x.category || '').toLowerCase() === 'exchange';
                const isExp = x.type==='expense'; 
                let cat = ''; 
                if(x.subLimitId) { const s = appData.subLimits.find(z=>z.id===x.subLimitId); if(s) cat = `<span class="text-[9px] bg-indigo-100 text-indigo-600 px-1.5 rounded ml-2 font-bold">${escapeHtml(s.name)}</span>`; } 
                else if(x.category && x.category !== 'Uncategorized') cat = `<span class="text-[9px] bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-300 px-1.5 rounded ml-2 font-bold">${escapeHtml(x.category)}</span>`;
                
                const acct = x.account || 'bank'; 
                const acctIcon = acct === 'cash' ? `<i class="fa-solid fa-money-bill-wave text-[10px] ml-1 text-gray-400" title="Cash"></i>` : `<i class="fa-solid fa-building-columns text-[10px] ml-1 text-gray-400" title="Bank"></i>`;
                const delBtn = isCurrentViewMonth() ? `<button onclick="deleteTransaction(${x.id})" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>` : '';
                
                let iconClass = isExp ? 'fa-bag-shopping' : 'fa-coins';
                let iconBg = isExp ? 'bg-red-100 text-red-500 dark:bg-red-500/20' : 'bg-green-100 text-green-500 dark:bg-green-500/20';
                let amountClass = isExp ? 'text-ios-red' : 'text-ios-green';
                let sign = isExp ? '-' : '+';
                
                if (isExchange) {
                    iconClass = 'fa-right-left';
                    iconBg = 'bg-blue-100 text-blue-500 dark:bg-blue-500/20';
                    amountClass = 'text-ios-blue';
                    sign = ''; // No sign for exchange to indicate neutrality
                }

                l.innerHTML += `<li class="flex justify-between items-center bg-white/50 dark:bg-white/5 p-4 rounded-2xl group transition hover:bg-white/80 dark:hover:bg-white/10 hover-lift gpu-accel"><div class="flex items-center gap-3 min-w-0"><div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${iconBg}"><i class="fa-solid ${iconClass} text-sm"></i></div><div class="min-w-0"><div class="flex items-center"><p class="font-bold text-sm dark:text-gray-100 truncate">${escapeHtml(x.desc)}</p>${cat}${acctIcon}</div><p class="text-[10px] text-gray-400">${new Date(x.date).toLocaleDateString()}</p></div></div><div class="flex items-center gap-3 shrink-0"><span class="font-bold ${amountClass}">${sign}${formatMoney(x.amount)}</span>${delBtn}</div></li>`;
            });
        }
        function renderComparison() {
            const b = document.getElementById('comparisonTableBody'); b.innerHTML = '';
            for(let i=0; i<6; i++) {
                let d = new Date(viewDate.getFullYear(), viewDate.getMonth()-i, 1); let inc=0, exp=0; appData.transactions.forEach(t=>{ const isExchange = (t.category || '').toLowerCase() === 'exchange'; if(!isExchange) { const td=new Date(t.date); if(td.getMonth()===d.getMonth() && td.getFullYear()===d.getFullYear()) { if(t.type==='revenue') inc+=t.amount; else exp+=t.amount; } } });
                const sav = inc - exp; b.innerHTML += `<tr class="border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-white/50 dark:hover:bg-white/5"><td class=\"py-3 pl-2 text-gray-500 dark:text-gray-400 font-medium\">${d.toLocaleDateString('en-US',{month:'short'})}</td><td class=\"py-3 text-right text-ios-green\">${formatMoney(inc)}</td><td class=\"py-3 text-right text-ios-red\">${formatMoney(exp)}</td><td class=\"py-3 text-right font-bold ${sav>=0?'text-ios-blue':'text-ios-orange'}\">${formatMoney(sav)}</td></tr>`;
            }
        }
        function initCharts() {
            const cfg = { type: 'doughnut', options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: {display:false}, tooltip: {enabled:false} }, animation: { duration: 600 } } };
            budgetChart = new Chart(document.getElementById('budgetWheel'), { ...cfg, data: { datasets: [{ data: [100, 0], backgroundColor: ['#007AFF', '#eee'], borderWidth: 0 }] } });
            bankChart = new Chart(document.getElementById('bankWheel'), { ...cfg, data: { datasets: [{ data: [50, 50], backgroundColor: ['#007AFF', '#eee'], borderWidth: 0 }] } });
            cashChart = new Chart(document.getElementById('cashWheel'), { ...cfg, data: { datasets: [{ data: [50, 50], backgroundColor: ['#34C759', '#eee'], borderWidth: 0 }] } });
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
